Practical Multilayered Materials

Michal Drobot Principal Rendering Engineer

Adam Micciulla Senior Rendering Engineer

Â© 2017 Activision Publishing, Inc.

Motivation

Cotton cloth

Opacity, Absorption, Scattering

Tinted glass

Paper

Â© 2017 Activision Publishing, Inc.

Â© 2017 Activision Publishing, Inc.

Â© 2017 Activision Publishing, Inc.

Frosted glass

Complex Materials

LLaaccqquueerreedd wWoooodd

Galvanized metal, oil layer Metallic paint

Â© 2017 Activision Publishing, Inc.

Â© 2017 Activision Publishing, Inc.

Â© 2017 Activision Publishing, Inc.

Hair Shader
Dust Shader

Production Oriented

Flag Shader

Translucency

Sand

Shader

Fuzz

Flake Color

Ice Shader

Subsurface Scattering

Opacity

Clear Coat Shader

Car Paint Shader

Angular Falloff

Scattering

Transparency

Trans color

Unified Shading Model
Unified Material Parametrization
Model

Generalized Material Model

Generalized Material Model

â€¢ Surface
â€¢ Geometric structure at interface
â€¢ Macro
â€¢ Geometric structure inside material
â€¢ Micro
â€¢ Medium lighting model

Surface

Macro Medium

interface

Â© 2017 Activision Publishing, Inc.

Â© 2017 Activision Publishing, Inc.

â€¢ Material with complex macro properties
â€¢ Semi-opaque cloth
â€¢ View dependent â€¢ Specular reflection remains

Â© 2017 Activision Publishing, Inc.

Macrostructure
interface

â€¢ Slice of cloth on macro level = tubes â€¢ Density and length of tubes defines perceptual â€˜opacityâ€™

Physical Macrostructure
â€¢ Opacity is a function of view angle, density and thickness of tubes

Ad-hoc Physically Based Opacity

â€¢ Groove shadowing defines angular change in opacity
â€¢ Inverse of Smith-Schlick Geometric Shadowing [HEI14]
â€¢ Macro groove layout implicitly given by density â€¢ Macro groove amplitude given by material thickness

Â© courtesy of Eric Heiz

Simple opacity alpha

Â© 2017 Activision Publishing, Inc.

Simple opacity alpha

Â© 2017 Activision Publishing, Inc.

Geometric opacity: thin surface

Â© 2017 Activision Publishing, Inc.

Geometric opacity: thick surface

Â© 2017 Activision Publishing, Inc.

float PhysicallyBased_GeometricOpacity( float NdotV, float alpha, float t ) // t - thickness {
float x = NdotV; float g = 1.0f - ( x / ( x * ( 1.0 - t ) + t ) ); // Smith-Schlick G return lerp( alpha, 1.0f, g ); // base opacity lerp to â€˜shadowedâ€™. Counteracts opacity change due to mips }

Generalized Macrostructure

â€¢ Material macro physical properties
â€¢ Density â€¢ Thickness
â€¢ Opacity â€“ derived from macro properties
â€¢ Probability of ray passing through material on macro level
â€¢ Affects whole BRDF (Diffuse & Specular)
â€¢ Macro level scattering & absorption
â€¢ Assumption - macro level does not influence micro level
â€¢ Future research [HEI16]

thickness

interface

medium

Generalized Macrostructure

â€¢ PCV
â€¢ Density = 1 â€¢ Thickness irrelevant

â€¢ Salt transition
â€¢ Density < 1 â€¢ Thickness relevant

Â© 2017 Activision Publishing, Inc.

Â© 2017 Activision Publishing, Inc.

Generalized Macrostructure for Material Blending
â€¢ Density used for partial â€˜material blendâ€™ or â€˜semi-opaqueâ€™ materials â€¢ Heightfield as â€˜thicknessâ€™ for height field blending [DRO10]

Mud to metal transition

Wet to dry asphalt transition

Microstructure
â€¢ Colored Glass
â€¢ Density = 1 â€¢ Thickness - relevant â€¢ Medium IOR - refraction
Â© 2017 Activision Publishing, Inc.

Thin Paper

Microstructure
Solid Wood

Â© 2017 Activision Publishing, Inc.

Â© 2017 Activision Publishing, Inc.

Thin Paper
BSDF

Microstructure

Specular

Solid Wood

Diffuse

BRDF

BTDF

Microstructure

â€¢ Material micro physical properties (medium)
â€¢ Absorption â€¢ Scattering â€¢ IOR â€¢ Transmittance â€¢ Other BRDF properties
â€¢ Conceptually similar to mix of volume and surface rendering [DUP16]

Â© 2017 Activision Publishing, Inc.

Â© 2017 Activision Publishing, Inc.

Transmittance 0.0 Scattering 0.0
BSDF

Transmittance 0.5 Scattering 0.0
BSDF

Transmittance 1.0 Scattering 0.0
BSDF

BTDF

BTDF

BTDF

â€¢ Simple BSDF
â€¢ Transmittance defines amount of diffuse energy that will be transmitted past medium interface

Transmittance 1.0 Scattering 1.0
BSDF

Transmittance 0.5 Scattering 0.5
BSDF

Transmittance 0.5 Scattering 0.5 Absorption 0.5
BSDF

BTDF

BTDF

BTDF

â€¢ Simple BTDF
â€¢ Surface roughness and medium scattering define ray scattering on material exit â€¢ Medium absorption and ray length (macro thickness and ray angle) define ray absorption
â€¢ Beer-Lambert Law

Material Compiler

Art-Oriented Material Definition [BUR12]

â€¢ Surface (structural)
â€¢ Normal â€¢ Roughness
â€¢ Macro (structural)
â€¢ Density â€¢ Thickness
â€¢ Micro (medium)
â€¢ Albedo â€¢ Sheen â€¢ Specular Color ( IOR derived [BUR15] ) â€¢ Anisotropy â€¢ Transmittance â€¢ Absorption color ( at distance [BUR15] ) â€¢ Scattering ( at distance â€˜roughnessâ€™ units )

Surface

Macro Medium

Building Blocks (Shader Code Blocks)

Specular GGX Anisotropic Specular GGX Ambient Specular GGX Smith-Schlick F Smith-Schlick G Beer Absorption

Lambert Diffuse

Disney Diffuse

Othersâ€¦

Surface Properties Micro Properties Macro Properties

Material Compiler

Optimized Material Shader
Optimized Render Setup (Passes, Blending)

Path-Based Material Evaluation

air

Light Quantities:

Evaluate Surface ( BSDF )

Diffuse & Specular

- accumulatedSpecular - accumulatedDiffuse

interface0 interface1
air

Evaluate Medium ( BTDF )

Volume Scattered Diffuse
Scattering & Absorption

Evaluate Material exit interface

Render Setup

View Ray Data: - rayAccumTransmittance - rayAccumScatter - rayIOR - rayDirection - rayPosition

Blending

View Ray Entering the Medium

Eye air
interface0 interface1 air scene

Light quantities (in eye dir): - accumulatedSpecular - accumulatedDiffuse
View Ray (at medium exit): - rayAccumTransmittance - rayAccumScatter - rayPosition

Light = specular +
diffuse * (1.0f â€“ transmittance)+
Integral(scene(position), scattering)* transmittance

Material Compiler Blend Setup

HW Blend Parameters: - addColorRGB - blendColorRGB - transparencyRGB
Light Quantities: - accumulatedSpecular - accumulatedDiffuse
View Ray: - rayAccumTransmittance - rayAccumScatter - rayPosition

NO

NO

transmittance

YES

!= 0

NO

IsMono(absorption) &&

YES

IsMono(specular)

scatter > 0.0 ||

YES

delta(position)

!= 0.0

Opaque
HW Blend
HW Dual Blend
Manual Blend SSRefraction

Blend Add with colored absorption HW Blend

Blend Add RGB with colored absorption HW Dual Blend

Correct specular Incorrect transmission

Â© 2017 Activision Publishing, Inc.
Correct specular Correct transmission

// Pre-Multiplied Alpha #if USE_BLENDFUNC_BLEND_ADD_RGB
#define TRANS_TYPE float3 struct PixelOutput{ float3 color :SV_TARGET0;
float3 color1 :SV_TARGET1; }; #elif USE_BLENDFUNC_BLEND_ADD
#define TRANS_TYPE float struct PixelOutput{ float4 color :SV_TARGET0; }; #endif

PixelOutput GetBlendingOutput( float3 blendColor, float3 addColor, TRANS_TYPE trans ) {

PixelOutput fragment = ( PixelOutput) 0;

float3 blend

= blendColor;

float3 add

= addColor;

#if USE_BLENDFUNC_BLEND_ADD_RGB

fragment.color1.rgb = trans;

#elif USE_BLENDFUNC_BLEND_ADD

fragment.color.a

= trans;

#endif

fragment.color.rgb = blend * trans + add;

return fragment; }

rgbOp ADD

HW Dual Blend BLEND_ADD_RGB

rgbSrc

rgbDst

aOp

aSrc

ONE

INV_SRC_ COLOR1

DISABLED

ONE

rgbOp ADD

HW Blend BLEND_ADD

rgbSrc

rgbDst

aOp

aSrc

ONE

INV_SRC_ ALPHA

DISABLED

ONE

aDst ZERO
aDst ZERO

Manual Blend Screen Space Refraction
â€¢ rayScattering -> PDF [STA15] â€¢ Calculate projected area of PDF
â€¢ Re-use IBL filtering math â€¢ Re-use Glossy Screen Space Reflection math
â€¢ Pick depth pyramid mip
â€¢ Projected area at short distance (~1m)
â€¢ Importance sample depth (using PDF)
â€¢ Jittered/dithered â€¢ Averaged depth
â€¢ Pre-filter backbuffer into pyramid
â€¢ PDF based importance sampling for each mip â€¢ Re-use pre-filtered IBL processing [MAN16]

Â© 2017 Activision Publishing, Inc.

â€¢ Project ray in 2D by ray length to average depth hit point
â€¢ Pick backbuffer mip level to match projected area of PDF at average depth hit
â€¢ Sample backbuffer at 2D hit location at selected mip level
â€¢ Blend of light quantities and refracted, scattered background in shader
â€¢ Refraction resolves â€¢ View model opaque â€¢ Scene opaque

Multilayered Materials

Surface Decomposition

Lacquered wood
Â© 2017 Activision Publishing, Inc.

dielectric dielectric

Surface Decomposition

Metallic paint

dielectric conductor

Â© 2017 Activision Publishing, Inc.

Surface Decomposition

Glazed carbon fiber

dielectric dielectric

Â© 2017 Activision Publishing, Inc.

Wood

Metallic paint

Carbon fiber

Lacquered wood

Â© 2017 Activision Publishing, Inc.

Glazed carbon fiber

Carbon fiber
Â© 2017 Activision Publishing, Inc.

Glazed carbon fiber

Tinted glazed carbon fiber
Â© 2017 Activision Publishing, Inc.

Glazed carbon fiber

Multilayered Material Compilation

Path-Based Material Evaluation

air
interface0 Interface 1,2â€¦n last interface air

Evaluate Material 0
Evaluate Material 1,2â€¦n
Evaluate Material n

Evaluate Material Exit If Last Interface

Render Setup

Light Quantities: - accumulatedSpecular - accumulatedDiffuse
View Ray Data: - rayAccumTransmittance - rayAccumScatter - rayIOR - rayDirection - rayPosition

Absorption
â€¢ Ray accumulates absorption for â€˜view pathâ€™ during IBL stage
â€¢ Incoming IBL lighting re-uses accumulated â€˜view pathâ€™ absorption (optimization)
â€¢ Pre-integrating integral is future research

IBL reflection / ambient

IBL reflection / ambient

Absorption
â€¢ Absorption of â€˜light pathâ€™ is accumulated during direct lighting stage per light
â€¢ Combined with â€˜view pathâ€™ absorption â€¢ Beer-Lambert law [CHA15]

float3 DirectAbsorption( float NdotV, float NdotL, float3 alpha, float d ) {
float3 color; float denom = max( NdotL * NdotV, 0.001f ); color = exp( -alpha * ( d * ( ( NdotL + NdotV ) / denom) ) ); return color; }

d - view d - light

Scattering
â€¢ â€˜Viewâ€™/â€˜Lightâ€™ â€˜pathâ€™ accumulates scattering as PDF width [KAR13]
â€¢ Interface roughness + medium scattering * macro thickness
â€¢ â€˜View pathâ€™ scattering changes evaluated surface footprint
â€¢ BRDF anti-aliasing techniques provide a way to evaluate larger footprint of surface BRDF [HAN07][HIL12]
â€¢ Calculate projected area of scattering PDF at thickness distance
â€¢ Calculate mip-map offset from area â€¢ Offset base mip-map picked by hardware

Â© 2017 Activision Publishing, Inc.

Â© 2017 Activision Publishing, Inc.

Example material compiler auto-optimizations

Is input specular texture
monochromatic?

Is transmission == 1.0?

Is thickness for top layer low?

Is bottom layer very rough and
non-metal?

Is scattering == 0.0?

Is input albedo texture black?

Use single channel transmission

Do not calculate diffuse

Remove support for refraction between
layers

Lower VGPR Lower ALU

Remove specular for bottom layer

Remove support for blurry refraction

Less render passes Lower ALU

Material optimizations
â€¢ Material Compiler auto-optimizations are crucial for performance
â€¢ Shader LOD
â€¢ Forward+ shader flow optimized for VGPRs
â€¢ [loop] for each light, [loop] for each layer
â€¢ Single world space position for rendering systems
â€¢ Reflection probes search and blending
â€¢ Multiple reflection probe samples with mipLevel[layerScatteringMip]
â€¢ Culled lights list lookup â€¢ Tetrahedron grid global illumination lookup â€¢ Multiple reflection probe samples with mipLevel[layerScatteringMip]

Various Forward+ material shaders generated by material compiler

Material

Fullscreen render time (PS4 @1080p)

VGPR Count

Effective ALU ops (with 1 light source)

Colored metal

1.51 ms

64

515

Thin film covered color metal

1.67 ms

64

543

Carbon fiber

1.24 ms

64

445

NaÃ¯ve Glazed Carbon Fiber

3.30 ms

128

980

Optimized Glazed Carbon Fiber

2.12 ms

84

707

Double-layered Ice w/ scattering

2.06 ms

84

714

Glass HW Blend

2.07 ms

64

724

Glass HW Dual Blend

2.17 ms

64

741

Glass SS Refraction

2.35 ms + 0.3 ms fixed pass

64

813

Art Material Setup

Albedo Color: none (optimization) Specular Color: non-metal Transmittance: 1.0 (optimization) Absorption: 0.98 0.89 0.83

Roughness: low

Albedo Color : wood texture Specular Color : non-metal Transmittance : 0.0

Roughness: high

Â© 2017 Activision

Â© 2017 Activision Publishing, Inc.

Â© 2017 Activision Publishing, Inc.

Â© 2017 Activision Publishing, Inc.

Â© 2017 Activision Publishing, Inc.

Â© 2017 Activision Publishing, Inc.

Â© 2017 Activision Publishing, Inc.

Thin Film

Heat treated pipe with oily layer

Soap bubble

Chemically treated aluminum

Â© 2017 Activision Publishing, Inc.

Â© 2017 Activision Publishing, Inc.

Â© 2017 Activision Publishing, Inc.

Thin Film Layer

[MAX14]

No thin film Layer

Â© courtesy of Next Limit [MAX14]
Natural oily thin film layer

Thin film reflectance
â€¢ Thin film reflectance is a function of wavelength, incidence angle, thickness and layer IORs [HAA07]
Î˜ â€¢ Very rough, but physically motivated approximation to thin film interference. Driven with existing material definition. â€¢ Run time application uses precomputed reflectance colors
for D65 light [HAA07] â€¢ Single modulated wavelength sampling
â€¢ Better approximations [BEL17]

Î» Split is at wavelength
Illustration only
n0

n1

d

n2

ğ‘ ğ‘ ğ‘–ğ‘–,ğ‘—ğ‘— = ğ¹ğ¹ğ¹ğ¹ğ¹ğ¹ğ¹ğ¹ğ¹ğ¹ğ¹ğ¹ğ¹ğ¹ğ‘…ğ‘…ğ‘ ğ‘ (ğ‘›ğ‘›ğ‘–ğ‘–, ğ‘›ğ‘›ğ‘—ğ‘—, ğœƒğœƒ)

ğ›¿ğ›¿ = 4ğœ‹ğœ‹ cos ğœƒğœƒğ‘¡ğ‘¡ğ‘¡ğ‘¡ğ‘¡ğ‘¡ğ‘¡ğ‘¡ğ‘¡ğ‘¡ğ‘¡ğ‘¡ğ‘¡ğ‘¡ğ‘¡ğ‘¡ğ‘¡ğ‘¡ğ‘¡ğ‘¡ğ‘¡ğ‘¡ âˆ— ğ‘›ğ‘›1 âˆ— ğ‘‘ğ‘‘/ğœ†ğœ†

ğ‘ğ‘ğ‘–ğ‘–,ğ‘—ğ‘— = ğ¹ğ¹ğ¹ğ¹ğ¹ğ¹ğ¹ğ¹ğ¹ğ¹ğ¹ğ¹ğ¹ğ¹ğ‘…ğ‘…ğ‘ğ‘(ğ‘›ğ‘›ğ‘–ğ‘–, ğ‘›ğ‘›ğ‘—ğ‘—, ğœƒğœƒ)

ğ¹ğ¹ğ‘ ğ‘  = ((ğ‘ ğ‘ 0,1)2+(ğ‘ ğ‘ 1,2)2 + 2 âˆ— ğ‘ ğ‘ 0,1 âˆ— ğ‘ ğ‘ 1,2 âˆ— cos(ğ›¿ğ›¿))/(1 + ğ‘ ğ‘ 0,1 âˆ— ğ‘ ğ‘ 1,2 2 + 2 âˆ— ğ‘ ğ‘ 0,1 âˆ— ğ‘ ğ‘ 1,2 âˆ— cos(ğ›¿ğ›¿))

ğ¹ğ¹ğ‘ğ‘ = ((ğ‘ğ‘0,1)2+(ğ‘ğ‘1,2)2 + 2 âˆ— ğ‘ğ‘0,1 âˆ— ğ‘ğ‘1,2 âˆ— cos(ğ›¿ğ›¿))/(1 + ğ‘ğ‘0,1 âˆ— ğ‘ğ‘1,2 2 + 2 âˆ— ğ‘ğ‘0,1 âˆ— ğ‘ğ‘1,2 âˆ— cos(ğ›¿ğ›¿))

ğ‘‡ğ‘‡ğ‘‡ğ‘‡ğ‘‡ğ‘‡ğ‘‡ğ‘‡ğ‘‡ğ‘‡ğ‘‡ğ‘‡ğ‘‡ğ‘‡ğ‘‡ = (ğ¹ğ¹ğ‘ ğ‘ +ğ¹ğ¹ğ‘ğ‘)/2

Thin film approximation

â€¢ Thin film approximation allows for varying reflectance/IOR of the bottom layer
â€¢ IORs derived from specular reflectance for air/surface interface â€¢ ğ‘Ÿğ‘Ÿğ‘–ğ‘– = ( ğ‘›ğ‘›ğ‘–ğ‘– âˆ’ ğ‘›ğ‘›0 â„ ğ‘›ğ‘›ğ‘–ğ‘– + ğ‘›ğ‘›0 )2
â€¢ Assume â€¢ n0 = 1.0 ( air )
Î˜ â€¢ r1 = 0.04 ( dielectric with average specular reflectance )
â€¢ ğ‘‡ğ‘‡ğ‘‡ğ‘‡ğ‘‡ğ‘‡ğ‘‡ğ‘‡ğ‘‡ğ‘‡ğ‘‡ğ‘‡ğ‘‡ğ‘‡ğ‘‡ğ‘…ğ‘…,ğºğº,ğµğµ ğ‘‘ğ‘‘, cos ğœƒğœƒ , ğ‘Ÿğ‘Ÿ1, ğ‘Ÿğ‘Ÿ2 =
âˆ« ğ¼ğ¼ğ¼ğ¼ğ¼ğ¼ğ¼ğ¼ğ¼ğ¼ğ¼ğ¼ğ¼ğ¼ğ¼ğ¼ğ¼ğ¼ğ¼ğ¼ ğœ†ğœ† âˆ— ğ¶ğ¶ğ¶ğ¶ğ¶ğ¶ğ‘…ğ‘…,ğºğº,ğµğµ ğœ†ğœ† âˆ— ğ‘‡ğ‘‡ğ‘‡ğ‘‡ğ‘‡ğ‘‡ğ‘‡ğ‘‡ğ‘‡ğ‘‡ğ‘‡ğ‘‡ğ‘‡ğ‘‡ğ‘‡ ğœ†ğœ†, ğ‘‘ğ‘‘, cos ğœƒğœƒ , ğ‘Ÿğ‘Ÿ1, ğ‘Ÿğ‘Ÿ2 dğœ†ğœ†
â€¢ 2D texture lookup stores reflectance convolved as offset to (Schlick) Fresnel â€¢ ğ‘‡ğ‘‡ğ‘‡ğ‘‡ğ‘‡ğ‘‡ğ‘‡ğ‘‡ğ‘‡ğ‘‡ğ‘‡ğ‘‡ğ‘‡ğ‘šğ‘šğ‘…ğ‘…,ğºğº,ğµğµ ğ‘‘ğ‘‘, cos ğœƒğœƒ , ğ‘Ÿğ‘Ÿ1, ğ‘˜ğ‘˜ âˆ’ ğ‘†ğ‘†ğ‘†ğ‘†ğ‘†ğ‘†ğ‘†ğ‘†ğ‘†ğ‘†ğ‘†ğ‘†ğ‘†(ğ‘˜ğ‘˜, cos ğœƒğœƒ ) â€¢ k â€“ const correlation factor for r1 / r2

Î» Split is at wavelength
Illustration only
n0

n1

d

n2

Thin film approximation rationale
â€¢ Plot of Fresnel for bottom surface and RGB reflectance vs cos(Î˜) for fixed thickness, film IOR and bottom surface IOR
â€¢ When the bottom surface IOR is varied, the difference between the RGB curves and the Fresnel curve remains approximately proportional at non-glancing angles.

Thin film approximation

ğ‘‡ğ‘‡ğ‘‡ğ‘‡ğ‘‡ğ‘‡ğ‘‡ğ‘‡ğ‘‡ğ‘‡ğ‘‡ğ‘‡ğ‘‡ğ‘šğ‘šğ‘Ÿğ‘Ÿ,ğ‘”ğ‘”,ğ‘ğ‘ d, cos ğœƒğœƒ , ğ‘Ÿğ‘Ÿ1, ğ‘Ÿğ‘Ÿ2 â‰ˆ ğ‘†ğ‘†ğ‘†ğ‘†ğ‘†ğ‘†ğ‘†ğ‘†ğ‘†ğ‘†ğ‘†ğ‘†ğ‘† ğ‘Ÿğ‘Ÿ2, cos ğœƒğœƒ + (ğ‘‡ğ‘‡ğ‘‡ğ‘‡ğ‘‡ğ‘‡ğ‘‡ğ‘‡ğ‘‡ğ‘‡ğ‘‡ğ‘‡ğ‘‡ğ‘šğ‘šğ‘Ÿğ‘Ÿ,ğ‘”ğ‘”,ğ‘ğ‘ ğ‘‘ğ‘‘, cos ğœƒğœƒ , ğ‘Ÿğ‘Ÿ1, ğ‘˜ğ‘˜ âˆ’ ğ‘†ğ‘†ğ‘†ğ‘†ğ‘†ğ‘†ğ‘†ğ‘†ğ‘†ğ‘†ğ‘†ğ‘†ğ‘† ğ‘˜ğ‘˜, cos ğœƒğœƒ ) âˆ— ğ‘ƒï¿½ğ‘ƒ(ğ‘Ÿğ‘Ÿ2, ğ‘Ÿğ‘Ÿ3)
â€¢ ğ‘ƒï¿½ğ‘ƒ was chosen by observing difference between thin film reflectance and bottom surface reflectance at cos ğœƒğœƒ = 1.

â€¢

Let ğ‘ƒğ‘ƒ ğ‘Ÿğ‘Ÿğ‘Ÿ, ğ‘Ÿğ‘Ÿğ‘Ÿ

= sup( ğ‘‡ğ‘‡ğ‘‡ğ‘‡ğ‘‡ğ‘‡ğ‘‡ğ‘‡ğ‘‡ğ‘‡ğ‘‡ğ‘‡ğ‘‡ğ‘‡ğ‘‡ ğœ†ğœ†, ğ‘‘ğ‘‘, 0, ğ‘Ÿğ‘Ÿ1, ğ‘Ÿğ‘Ÿ2
âˆ€ğœ†ğœ†,ğ‘‘ğ‘‘

âˆ’ ğ‘Ÿğ‘Ÿ2 ). ThinFilm reflectance is periodic for ğ‘‘ğœ†ğ‘‘ğœ†, so this is easy to

compute.

â€¢ Choose k such that P(r1,k) is maximized and normalize ğ‘ƒï¿½ğ‘ƒ ğ‘Ÿğ‘Ÿ1, ğ‘Ÿğ‘Ÿ2 = ğ‘ƒğ‘ƒ(ğ‘Ÿğ‘Ÿ1, ğ‘Ÿğ‘Ÿ2)/ğ‘ƒğ‘ƒ(ğ‘Ÿğ‘Ÿ1, ğ‘˜ğ‘˜)
â€¢ For our chosen value of ğ‘Ÿğ‘Ÿ1, ğ‘ƒï¿½ğ‘ƒ ends up being roughly parabolic with max at ğ‘˜ğ‘˜ â‰ˆ 0.5. Accuracy was not a huge concern for this feature, so we simplified things even further and set ğ‘ƒï¿½ğ‘ƒ ğ‘Ÿğ‘Ÿ1, ğ‘Ÿğ‘Ÿ2 = 4 âˆ— ğ‘Ÿğ‘Ÿ2 âˆ— (1 âˆ’ ğ‘Ÿğ‘Ÿ2)

Â© 2017 Activision Publishing, Inc.
float3 ApplyThinFilm( float3 fresnel, float NdotL, float2 thicknessAndIntensity, float3 specSample ){ float3 lutSample = thinFilmLUT.SampleLevel( linear, float2( thicknessAndIntensity.x, NdotL ), 0 ).rgb - 0.5f; float3 intensity = thicknessAndIntensity.y * 4.0f * ( specSample * ( 1.0f - specSample ) ); return saturate( lutSample * intensity + fresnel );}
float3 PhysicallyBased_GetPrimaryFresnelWithSpecColor( SurfaceAttributes surfaceAttributes, float dotH ){ float3 primaryFresnel = SchlickPrimaryFresnel( abs( dotH ), surfaceAttributes.specColor ); return = ApplyThinFilm( primaryFresnel, abs( dotH ), surfaceAttributes.thinFilmThicknessAndIntensity, surfaceAttributes.specColor ); }

Â© 2017 Activision Publishing, Inc.
â€¢ Art controls
â€¢ Intensity texture â€¢ Thickness texture â€¢ Min / max thickness range â€¢ Custom LUT

Default r1 Air LUT Custom Methane LUT

Thin film layer
Â© 2017 Activision Publishing, Inc.

Â© 2017 Activision Publishing, Inc.

Â© 2017 Activision Publishing, Inc.

Future Research
â€¢ Multi-scattering [HEI16] â€¢ Scattering between surfaces [DUP16] â€¢ Approximating complex BRDFs with multilayer Material Compiler
â€¢ TRT hair shading â€¢ Path based shading/lighting models
â€¢ Getting closer to movie industry material shaders and quality [HER17]
â€¢ Not far away in terms of feature set â€¢ â€œPixarâ€™s Foundation for Materials: PxrSurface and PxrMarschnerHairâ€

Rendering Presentations 2017

â€¢ EGSR
â€¢ Ambient Dice
â€¢ Siggraph
â€¢ Indirect Lighting in COD: Infinite Warfare â€¢ Dynamic Temporal Supersampling and Anti-Aliasing â€¢ Improved Culling for Tiled and Clustered Rendering â€¢ Practical Multilayered PBR rendering
â€¢ Microsoft XFest 2017
â€¢ Optimizing the Renderer of Call of Duty: Infinite Warfare

Michal Iwanicki
Michal Iwanicki Jorge Jimenez Michal Drobot Michal Drobot
Michal Drobot

research.activision.com

JOIN US
www.activisionblizzard.com/careers

Special Thanks

â€¢ Tech Art
â€¢ Kyle McKisic â€¢ Olin Georgescu

â€¢ Code
â€¢ Adam Micciulla
â€¢ amicciulla@gmail.com

PBS Course Organisers: Stephen Hill
Stephen McAuley

Additional Thanks
â€¢ IW Rendering Team
â€¢ Anthony Carotenuto, Rulon Raymond, Peter Pon, Mike Esposito, Vishal Kashyap, Felipe Gomez
â€¢ Activision Central Tech â€¢ Infinity Ward
â€¢ Sledgehammer Games â€¢ Treyarch â€¢ Raven

research.activision.com
Q&A
michal@infinityward.com @MichalDrobot

References 1/2
[ADA03] â€œReal-time Rendering of Woven Clothesâ€, Neeharika Adabala, Nadia Magnenat-Thalmann, Guangzheng Fei, VRST 2003 [BEL17] â€œA Practical Extension to Microfacet Theory for the Modelling of Varying Iridescenceâ€, Laurent Belcour and Pascal Barla, Siggraph 2017 [BUR12] â€œPhysically-Based Shading at Disneyâ€, Brent Burley, Siggraph 2012 [BUR15] â€œExtending the Disney BRDF to BSDF with Integrated Subsurface Scatteringâ€, Brent Burley, Siggraph 2015 [CHA15] â€œReal-World Measurements for Call of Duty: Advanced Warfareâ€, Danny Chan, Siggraph 2015 [DRO10] â€œQuadtree Displacement Mapping with Height Blendingâ€, Michal Drobot, GDC Europe 2009 [DRO17] â€œRendering of Call of Duty: Infinite Warfareâ€, Michal Drobot, Digital Dragons 2017 [DUP16] â€œAdditional Progress Towards the Unification of Microfacet and Microflake Theoriesâ€, Jonathan Dupuy, Eric Heitz and Eugene dâ€™Eon, EGSR 2016 [HAA07] â€œThin Film Renderingâ€, Tomas Bernhard Haarde and Pall Ragnar Palsson, DTU/ITU Master Thesis, 2007 [HAN07] â€œFrequency Domain Normal Map Filteringâ€, Charles Han, Bo Sun, Ravi Ramamoorthi and Eitan Grinspun, Siggraph 2007 [HER17] â€œPixarâ€™s Foundation for Materials: PxrSurface and PxrMarschnerHairâ€, Christophe Hery and Junyi Ling, Siggraph 2017

References 2/2
[HAN07] â€œFrequency Domain Normal Map Filteringâ€, Charles Han, Bo Sun, Ravi Ramamoorthi and Eitan Grinspun, Siggraph 2007 [HER17] â€œPixarâ€™s Foundation for Materials: PxrSurface and PxrMarschnerHairâ€, Christophe Hery and Junyi Ling, Siggraph 2017 [HIL12] â€œRock-Solid Shading: Image Stability Without Sacrificing Detailâ€, Dan Baker and Stephen Hill, Siggraph 2016 [HEI14] â€œUnderstanding the Masking-Shadowing Function in Microfacet-Based BRDFsâ€, Eric Heitz, Journal of Computer Graphics Techniques Vol. 3, No. 2, 2014 [HEI16] â€œMultiple-Scattering Microfacet BSDFs with the Smith Modelâ€, Eric Heitz, Johannes Hanika, Eugene dâ€™Eon and Carsten Dachsbacher [KAR13] â€œReal shading in Unreal Engine 4â€, Brian Karis, Siggraph 2013 [MAN16] â€œFast Filtering of Reflection Probesâ€, Josiah Manson and Peter-Pike Sloan, EGSR 2016 [MAX14] â€œPushing the limits of realism of materialsâ€, Atilla Akin, Maxwell Render Team, blog entry [SCH12] â€œRecent Advances in Physically-Based Appearance Modeling of Clothâ€, Kai Schroder, Shuang Zhao and Arno Zinke, 2012 [STA15] â€œStochastic Screen-Space Reflectionsâ€, Tomasz Stachowiak and Yasin Uludag, Siggraph 2015 [WEI07] â€œArbitrarily Layered Micro-Facet Surfacesâ€, Andrea Weidlich and Alexander Wilkie

