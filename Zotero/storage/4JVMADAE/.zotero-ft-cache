Dallas, August 18-22

Volume 20, Number 4, 1986

THE RENDERING EQUATION
James T. Kajiya California Institute of Technology
Pasadena, Ca. 91125

A B S T R A C T . W e present an integralequation which generallzesa variety of k n o w n rendering algorithms. In the course of discussing a monte carlo solutionwe alsopresent a new form of variance reduction, calledHierarchical sampling and give a number of elaborations shows that itm a y be an efficient n e w technique for a wide variety of monte carlo procedures. T h e resulting renderlng algorithm extends the range of optical phenomena which can be effectivelysimulated.
K E Y W O R D S : computer graphics, raster graphics~ ray tracing~ radiosity~ m o n t e carlo, distributed ray tracing, variance reduction.
C R C A T E G O R I E S : 1.3.3,1.3.5, 1.3.7

1. The rendering equation
The technique we present subsumes a wide variety of rendering algorithms and provides a unified context for viewing them as more or less accurate approximations to the solution of a single equation. That this should be so is not surprising once it is realized that all rendering methods attempt to model the same physical phenomenon, that of light scattering off various types of surfaces.
We mention that the idea behind the rendering equation is hardly new. A description of the phenomenon simulated by this equation has been well studied in the radiative heat transfer literature for years [Siegel and Howell 1981]. However, the form in which we present this equation is well suited for computer graphics, and we believe that this form has not appeared before.
The rendering equation is
I(z,z') = g(x,x'} [e(z,x') + fsp(=,a:',x")[(z',x"}dz" ] . (1)

where:
x(=, ~') ~,((=x,, ==9') p(z, z'=")

is the related to the intensity of light passing from point z' to point x is a ~geometry~ term is related to the intensity of emitted light
from x' to x
is related to the intensity of light scattered
from x" fox by a patch of surface at z'

Permission to copy without fee all or part of this material is granted provided that the copies are not made or distributed for direct commercial advantage, the ACM copyright notice and the title of the
publication and its date appear, and notice is given that copying is by
permission of the Association for Computing Machinery. To copy otherwise, or to republish, requires a fee and/or specific permission.
© 1986 ACM 0-89791-196-2/86/008/0143 $00.75

The equation is very much in the spirit of the radiosity equation, simply balancing the energy flows from one point of a surface to another. The equation states that the transport intensity of light from one surface point to another is simply the sum of the emitted light and the total light intensity which is scattered toward z from all other surface points. Equatlon (1) differs from the radiosi~y equation of course because, unlike the latter, no assumptions are made about reflectance characteristics of the surfaces involved.
Each of the quantities in the equation are new quantities which we call
unoecluded multipoint transport quantities. In section 2 we define each
of these quantities and relate them to the more conventional quantities encountered in radiometry.
The integral is taken over S = U s i , the union of all surfaces. Thus the points x, x'~ and x" range over all the surfaces of all the objects in the scene. We also include a global background surface So, which is a hemisphere large enough to act as an enclosure for the entire scene. Note that the inclusion of a enclosure surface ensures that the total positive hemisphere for reflection and total negative hemisphere for transmission are accounted for.
As an approximation to Maxwell's equation for electromagneticseq. (1) does not attempt to model all interesting optical phenomena. It is essentially a geometrical optics approximation. We only model time averaged transport intensity, thus no account is taken of phase in this equation--ruling out any treatment of diffraction. We have also assumed that the media between surfaces is of homogeneous refractive index and does not itself participate in the scattering light. The latter two eases can be handled by a pair of generalizations of eq. (1). In
the first case, simply by letting g{x, z') take into account the eikonal
handles media with nonhomogenousrefractive index. For participating propagation media, a integro-differentiM equation is necessary. Extensions are again well known, see [Chandrasekar 195% and for use in a computer graphics application [Kajiya and yon Herren 1984]. Elegant ways of viewing the eikoual equation have been available for at least a century with Hamilton-Jacobi theory [Goldstein 1950]. Treatments of participatory media and of phase and diffraction can be handled with path integral techniques. For a treatment of such generalizations concerned with various physical phenomena see [Feynman and Hibbs 1965]. Finally, no wavelength or polarization dependence is mentioned in eq. (1). Inclusion of wavelength and polarization is straightforward and to be understood.
2. Discussion of transport quantities
We discuss each of the quantities and terms of equation (1}. This equation describes the intensity of photon transport for a simplified
model. I(x, zl) measures the energy of radiation passing from point zI to point x. We shah name [(z~ x ~) the unoccluded two point transport intensity from x' to x, or more compactly the transport intensity. The transport intensity I(x, x') is the energy of radiation per unit time per

143

S I G G R A P H '86

unit area of source dz' per unit area dx of target.

dE = I(x, x'} dtdx dx'.

(2)

The units of 1 are joule/m4sec,

The term g(x, x') is a geometry term. This term encodes the occlusion of surface points by other surface points. If in the scene~ x' and x axe not in fa~ct mutually visible then the geometry term is 0. On the other hand if they are visible from each other then the term m 1/r 2 where r is the distance from x' to x. Note that an occluding perfectly
transparent surface can m a k e 9(x, z') to be equal 0. For, in fact, the
transparent surface, intercepts the radiation and reradiates it on the other side.

The emittance term, e(x, xI) measures the energy emitted by a surface at point x' reaching a point z. We shall call it the unoccluded two point transport emittanee from x~ to x. It gives the energy per unit time per unit area of source and per unit area of target. That is,

d E = ~1, ( x , x )dr d~ dx r.

(3)

The units of ~(x,x 1) are joule/m~sec,

Finally the scattering term p(x,z',x') is the intensity of energy scat-

tered by a surface element at x' orginating from a surface element at

x" and terminating at a surface element at ~. W e shall call it the

unocciuded t/tree lvoictt lra~ts~ort reflectance from z" to = through xl.~ The term p is a dimensionless quantity. So the energy reaching = is

given by

dE = .~-~(=, =1, =,,)~( ,, ,,} d~d~ d~' d~"

(4)

W e n o w relate the transport quantities to more conventional radiometric quantites. W e shall do this by equating the energy transported by each quantity for the given geometric configuration.

Ordinary radiometric intensity is defined as energy per unit time per unit of projected area of source per unit of solid angle

d E = i(0', ¢')dw dx~ dr.

(5)

To relate these quantities w e look at the imaging geometry in figure I.

n is the normal to surface element dx n ~ is the normal to surface element dx~ t' m the tangent vector to the element dx'
r is the distance from x' to
The solid angle subtended by a surface element dx is the fractional
area of a sphere of radius r taken up by the projected area dxp of dx.

So., = -d~x-p = ~ cos e dz.

(7)

Thus substituting eq. (7) in eq. (5) we get

d E = i C81, ¢') 1 cos 9 cos 0'dt d z dx I.

(s)

r-

Equating eq. (2) and eq. 15) gives the relationship between transport intensity and ordinary intensity

*(x, =9 = ice, ¢) ~1 cos0 cos0'.

(9)

The relation between transport emittance and ordinaryemittance is derived likewise. Assuming that there are no occluding surfaces, the energy transmitted by emission from surface element dx r to dx is given by eq. (3). Using the definition of ordinary emittance we can follow exactly the same procedure as above to obtain

~C~,=') = eC0',¢ ) cose cos0'

(i0}

Finally~ we relate the t r a n s p o r t reflectance to the ordinary radiometric

total bidirectional reflectance functionp(O', ¢', ~', a') from the defini-

tion

K0', ¢) = p(0', ¢', V, ~')i(¢',,¢)~1'cos¢'

(1~).

W h e r e the imaging geometry appears in figure 2. rd

Figure I. Two point imaging geometry. A frame ivattached to each Burfaceelement giving a normal, tangent, and binormal vector.

F r o m the figure we obSain

= II=- =111 d x ~ = d z I cos 0

cos~ = ~(n,x- x')

(6)

cos O' = -l(n',~ - 1)
r

cos¢' = ~(t',= - =')

where:

This term also covers the transmittance of light through surfaces as well. To simplify the ensuing discussion we will ignore transmission scattering altogether.

M Figure 2. Three point imaging geometry.

From the diagram we obtain in addition to equations {6) and (7), the following
r" = I1='-- ="11
d~ = dz" cos'¢,"

cos ¢ ' = ~,71(n ' x' - x")

cos.,,b" = ~7~nl"., ~t _ x ' )

(12}

cos~l= ~17{t, xl - xl/)

d.o/' = -dr#x-/~2= r ~ c °1s ¢

,, d= .

where:
n" is the normal to surface element dx" r" is the distance from x" to x~ dwtl is the solid angle subtended by surface element dx"

Combining eqs.(2),(8),(9),(11), and (12) we obtain the relationship
between the unoccluded three point transport reflectance and the or-

144

Dallas, August 18-22

IIII

.

I

Volume 20, Number 4, 1986

I

III II

dinary total bidirectionalreflectance
p(~, =', =") = e(o', ¢', 9', ,~') cos 0 cos o'

Whitted [1980], proposed a different approximation:

(1~)

I = ge + gMogeo -F gMogMogeo + . . .

8. Methods for approximate solution
In this section we shall review approximations to the solution of the rendering equation. It appears that a wide variety of rendering algorithms can be viewed in a unified context provided by this equation. During the course of this discussion, many other untried approxlmw tions m a y occur to the reader. W e welcome additional work on this area. This territoryremains l~gely unexplored~ since the bulk of the present effort has concentrated solely on the solution methods to be presented below.

Ne s.m~u serses

One method of solving integral equations like eq.(1} comes from a well known formal manipulation, see [Courant and Hilbert 1953]. W e rewrite it as:
I = g~+ g M l
where M is the linear operator given by the integralin eq.(l). N o w if we rewrite this equation as

(1 -- g M ) I -~ ge

where 1 is the identityoperator, then we can formally invert the equation by

jr = (1 -- g M ) - l g e

= ge + gMge + gMgMge + g(Mg}Se ...

{2)

A condition for the convergence of the infinite series is that the spectral radius of the operator M be less than one. {Which is met in the case of interestto us). A physical interpretationof the N e u m a n n expansion is appealing. It gives the finalintensityof radiation transfer between points x and x~ as the sum of a direct term, a once scattered term, a twice scattered term, etc.

The Utah approzlmation

For lack of a better name, we shall call the classical method for rendering shaded surfaces the Utah approximation. In this approximation we approximate I with the two term sum:
I = ge + g M e o

Thus the Utah approximation ignores all scattering except for the first. The geometry term is by far the most difficultto compute. The Utah approximation computes the g term only for the finalscattering into the eye. This is, of course, the classicalhidden surface problem studied by m a n y early researchers at the University of Utah. Note that in the second term, the operator M does not operate on ge but rather directly on e0- Thus this approximation ignores vlslbilty from emitting surfaces: it ignores shadows. The e0 term is mesas to signify that only point radiators ~re allowed. No extended lighting surfaces were allowed. This simplification reduces the operator M to a small sum over light sources rather than an integration over ~".
Since that time m a n y extensions have appeared, most notably shadow algorithms and extended light sources.
The Ray Tracing approximation

In this famous approximation, Me is a scattering model which is the sum of two delta functions a cosine term. The two delta functions of course represent the reflection and refraction of his lighting model. The cosine term represents the diffuse component. Note that he gives gee: shadows but with point radiators. Whitted's ambient term translates directly to the • term. Again the operator M can be approximated by a small sum.
The distributed ray tracing approximation

In 1984, Cook [Cook et al 1984], introduced distributed ray tracing. This approximation uses an extension of the three component Whitted model resulting in a more accurate scattering model. This extension necessitated the evaluation of an integral in computing the operator M . In this model M is approximated by a distribution around the reflection a~td refraction delta functions. The innovation that made this possible was the use of monte carlo like techniques for the evaluation. As is well known, the abilityto evaluate integralshas widely extended the range of optical phenomena captured by this technique. A proper treatment of the ambient term, however, remained elusive to distributed ray tracing.
The radioMty approximation

In 1984, Goral, Torrance, and Greenburg [Goral et. aL 1984, Cohen m d Greenburg 1985, Nishita and Nakamas 1985] introduced radiosity to the computer graphics world. This is a major new rendering technique which handles the energy balance equations for perfectlydiffuse surfaces. That is, surfaces which have no angular dependence on the bidirectionalreflectance function

p{O', ¢', ¢', ~,') = Po.

(14)

The radiosit9 B(x') of a surface element dx' is the energy flux over

the total visible hemisphere. It is the energy per unit time per unit

(unprojected) area, measured in watts per meter squaxed. It is defined

by

an'] dB{=') =

qo',¢) cos e'~

..1hctrti

f = an'

:C=,=')r'~

(i~)

J heml C ~

= dz' J[ S /C=,=')d=

Thus to calculate hemispherical quantities we m a y simply integrate over all the surfaces in the scene. So from eq.(1) and (15) we obtain
= dB(x') / { g{., .,),{.,
(16)
[ +g(~, =') : p(=, =', ="} r(~', =")de'} d~

If there is an occlusion between ~ and x* then the contribution of the emmitance term is zero. Otherwise the contribution is

dB,(x') dx' [ ~q=- -' -=d')x

d='f dO,,¢ ,) cose ,¢os~ea=

(17)

J

= dz' J eCe',¢' } cos e'd~

~_ dxt ~ o

145

S I G G R A P H '86

W h e r e ~o is t h e h e m i s p h e r i c a l e m i t t a n c e of the surface e l e m e n t dx'.
Similarly for the reflectance term, the contribution to radiosity is again zero for an occluded surface. Otherwise we get

dB,(x')=dx'f ~ f p(x,z',x")z(z',z")dz"dz

= ax,f ~p(O',¢',¢',a')cosOcosO'd~

× / I(x', x")dx"

(is)

= dxlpo~rH(x')

Where H is the hemispherical incident energy per unit time and unit area. In this derivation we switched the order of integration and used identities (13),(12), and (14). Now using equations (17) and (18) in (16) we see that the rendering equation becomes

dB(x') = ~r[e0 + poH(x')]dx'

(19)

Which is equation (4) in Octal et. al. [1984].
Calculating the total integrated intensty H is essential to calculate
t h e final F~d m a t r i x in radiosity. T h i s r e q u i r e s a v i s i b i l i t y c a l c u l a t i o n
which may be Quite expensive. Since the matrix equation is solved by a number of relaxation steps, it is essentially equivalent to s u m m i n g the first few terms of the Neumann series: propagating the emitters across four or so scatterers. To use relaxation requires that the full matrix be calculated. Relaxation also gives all the intensities at all the surfaces in the scene. While in certain cases this may be an advantage~ it is suggested that the monte carlo method outlined below may be quite superior.

4. Marker chains for solving integral equations
The use of Markov chains is perhaps the most popular numerical method for for solving integral equations. It is used in fields as diverse as queuing theory and neutron transport. In facts the use of monte carlo Markov chain methods in radiative heat transfer has been in use for quite some time, [Siegel and Howell 19811. In the heat transfer approach, a packet of radiation of specified wavelength is emitted, reflected, and absorbed from a configuration of surfaces in some enclosure. Counting the number of packets absorbed by each surface after a run gives an estimate of the geometric factors whose exact calculation would pose an intractible problem. This is similar to ray tracing a scene from the light sources to the eye. Rather than follow these methods, we will choose to solve eq.(1) more directly going back to an early monte carlo method first put forth by yon N e u m a n n and U l a m [Rubenstein 1981].

Finite dimensional version

By way of introduction we first present the method in a finite dimensional context. This simplifies the notation and makes obvious the essential ideas involved. Again we note that this example method may possibly hold many advantages over the currently used relaxation schemes popular in radiosity: intensities at only visible points need be computed, and calculation of the full radiosity matrix may be exchanged for a very much smaller set of selected matrix elements.
Suppose we wish to solve the vector equation:
x=aWMx
where x and a are n-dimensional vectors~ x an unknown, and M =
(miy) is an n X n m a t r i x .
Now from a Neumann expansion we see that for M a matrix with
146

eigenvalues lying within the unit circle, the solution x is given by co
x=a+ZMka
k=l
The method evaluates this sum by averaging over paths through the matrix multiplies. That is, it follows a path through rows and columns that comprises an iterated matrix product. For each point in the path we get a row or column which can be indexed by an integer from 1 to

Construct a probability space g/where each point w is a path visiting one of n points at each discrete time, "vis, w = (n0,nt,...,n~) where each n~ is a n i n t e g e r f r o m 1 t o n. T h e l e n g t h k = l{w) of the p a t h w is finite but otherwise arbitrary and corresponds to an entry in the kth
m a t r i x power. E a c h p a t h is a s s i g n e d a p r o b a b i l i t y p(w).

If we w i s h to c a l c u l a t e t h e v a l u e of one c o o r d i n a t e of x~ s a y xjL, t h e n we calculate the quantity

l(~)

~' = (1~ m ...... i=O

)~-,,-i p(1~)

averaged over all paths w E t~. Simply taking expected values verifies that this quantity gives the desired quantity.

The probability space of paths is most easily constructed using Maxkov
chains. A (stationary) discrete Markov chain consists of a set of states
X, and an a s s i g n m e n t of a transition probabilityp(x, x') from one s t a t e
x' ~ X to another x E X~ and an initial probability density of states
p(x). Some s u b s e t of s t a t e s m a y be d e s i g n a t e d as absorbing in t h a t no
transitions out of an absorbing state axe permitted.

The probability of a path generated by a Maxkov chain is simply the the product of the initial state and all the transition probabilities u~tll an absorbing state is reached. So for a path

we have the probability is

In the finite dimensional ease we let the state set of the Markov c h i n be the set of indices into the vector or matrix, X = {1, ..., n}. Note that although we axe allowed wide lattltude in choosing the transition probabilities, they must be positive for the corresponding nonzero entries in the matrix. In the limit our estimate of the solution is quite independent of the probability distribution of the paths. But the rate of convergence to the limit is highly dependent on the manner of choosing the transition probabilities. Section 5 gives a set of new techniques for choosing the transition probabilities.
Infifiaitc dimaasional solution
Extending the monte carlo Marker chain method to infinite dimensional equations is straightforward. For the equation at hand, we Rote that it is a variant of a Fredholm equation of the second kind. The passivity of surfaces in reflecting and transmitting radiation assures the convergence of the Neumann series. We simply replace the state set by the set of points x on a surface. The procedure for calculating the points is thus:
1. Choose a point z' in the scene visible through the imaging aperture to a selected pixel z on the virtual screen.
2. Add in the radiated intensity. 3. For the length of a Marker path do
3.1 Select the point zs~ and calculate the geometrical factor g(z, zt). 3.2 Calculate the reflectance function @(z,x', z") and multiply by ((z', x"). 3.3 Add this contribution to the pixel intensity.
Note that calculating the emittance and scattering factors is simply a matter of consulting texture m a p s and lighting models. Calculating

Dallas, August 18-22

Volume 20, Number 4, 1986

the geometrical factor is, in fact, the ray-object intersection calculation of ray tracing. Note als% that by choosing the next point x" on the Markov path by shooting a ray at an chosen angle and finding the closest intersection point, we in effect perform a powerful importance sampling optimization. That is, we do not bother to calculate the integral for points x ~,~ which are occluded by another surface because we k n o w the integral will be zero. This is in contrast to the relaxation procedure in radiosity which always takes energy contributions from all surfaces.
5. Hierarchical sampling
We now present a number of new variance reduction techniques invented for solving the rendering equation. We hasten to point out, however, that the variance reduction techniques exposed here are of much wider scope. Generally they will have utility in all manner of monte carlo integration problems in which the integrand is particularly difficult. In this situations the increased overhead beyond previously k n o w n methods becomes negligible. W e present five methods which take increasing advantage of precious samples of the integrand. All the techniques outlines below were inspired by stratified sampling.
Sequential uniform sampling
The first sampling technique stems from a common sequential sampling strategy. Often samples of the integrand are repeatedly collected until the sample variance of the integral estimate falls below a fixed threshold. This strategy has been shown to be of advantage in [Lee, R e d n e r and Uselton 1985], where m a n y samples were collected at interesting parts of the image while few were collected at uninteresting parts.
Unfortunately, this sequential strategy is incompatiblewith stratified sampling. In the stratified sampling technique, the domain of interest is divided into snbcells. Lee, et. al. used a fixed subdivision of 8 cells per pixel and randomly collected samples within each cell. Ideally, better convergence is obtained w h e n one sample per cell is collected~ where the cells uniformly divic~e the domain--thls is the so called jitter sampling method, where ordinarily we think of the centers of the cells a~ forming a lattice. The incompatibility between sequential and jitter sampling arises because a uniform subdivision of the domain is impossible until it is k n o w n precisely h o w m a n y samples will be collected.
Sequential uniform sampling achieves this by keeping a tree of cells of varying sizes. Each time a sample is to be cast, a cell is first chosen and then divided into cells. The old sample of the original cell must lle in one of the n e w subcells. The n e w sample is chosen to lie in the opposite cell. A simple example will illustrate this technique.
Suppose we are sampling a unit interval and have already cast 5 samples. The cells chosen with sample points appear thus:

Sz

5~

,Sj ss

~

To cast a new sample point we traverse the tree until a leaf cell is encountered. We then split the leaf cell in half and cast the sample into the empty half cell.

REFINE A NODE I. Ifthe node is an internalnode
1.I~ Chooze ~ subnode 1.2 Refine the chosen subnode 1.3 Return 2. Else,splitthe leafnode 3. Propagate the old sample into the eubleaf containing it. 4. Cast a new sample in the remaining empty subleaf
How can we assure that the most uniform possible subdivision is comp u t e d ? O n e w a y would be to traverse the sampling tree in breadth first order. Splitting each leaf node at every level before splitting deeper nodes. This strategy produces highly n o n r a n d o m sample distributions, essentially scanning across the interval. A better method is to split nodes breadth first in r a n d o m order. The following criteria effect this strategy
CHOOSE A SUBNODE 1. If either is a leaf choose it. 2. Choose left node if
level(left)<level(right) and left is balanced 3. Choose right node if
level(right)<leveI(left) and right is balanced 4. Choose raaad0mly otherwise.
Note that this strategy will in effect perform a random search throughout the interval, without concentrating on any particular area.
The multidimensional case
The above algorithm is easily extended to higher dimensions simply by xtslng a data structure k n o w n as a k-d tree due to Bentley IBentley 1979]. In this data structure, the domain is succesively divided into two halves by a hyperplane perpendicular to successive coordinate axes. Thus for say a unit square, the k-d tree subdivides first along a vertical line, then on the next level d o w n along the horizontal. The uniform subnode choice rules above ensure a uniform subdivision without any modification. Generalization to path spaces is straightforward.
Hierar¢hical ini¢gration
The third version of the above technique takes advantage of the fact that the cells for each sample are recorded with each sample. In this way we may compute a Riemann sum using the volume of the cell and the vahte of the cast sample as integrand. Yakowitz [Yakowit~ et al 1978] has proposed a variant of this m e t h o d (using the samples themselves as boundary points with no stratification). He has reported a variance of O(n -4) in the one dimensional ease, and a variance of
O(n -2) in the two dimensional case. This is in vastly superior to the
O(n -1) of simple monte carlo. The analysis of our technique is still under investigation, and will appear in a companion paper. But due to the stratification of our samples, early evidence suggests that this is a superior technique for integration.
Each time a leaf cell is split, its contribution to the total integral is divided in half. The new integrand sample is multiplied by the volume of empty cell. After splitting and sampling has occurred, the path from the leaf to the root is traversed, updating the integral stored at each node to be the sum of the integrals of its subnofles. By keeping the integral of nonroot internal nodes we are able to automatically scale the by the density of the samples to maintain a constant measure.
Figure 3 shows the convergence of a two dimensional integral as compared to the conventional monte carlo technique. The value of the integral estimate is plotted versus number of samples cast. The conventional estimator is shown above and the hierarchical integrator is shown below. We are integrating a simple step function on a connected region of the plane.

147

S I G G R A P H '86
IIII

Adaptive hierarchical integration

The fourth elaboration of thls technlque concerns other criteria besides uniformity of samples in the domain. In this variation~ we seek to concentrate samples in interesting parts of the domain and to sparsely sample those areas in which the integrand is nearly constant.
We seek criteria for selecting interesting parts of the tree to undergo further refinement. How can these criteria be included in the algorithm? It is easy to think of the subnode selection rules of the uniform sequential sampler as a way of setting probability thresholds. Choose a uniform random number in the unit interval. The uniform rule calculates a threshold ~ which is either 1 or 0 if the rule says to choose left or right subnode. If the rule says to choose randomly, the threshold is set to 0.5.
Now let us calculate a number of thresholds ¢1,...,¢k. To take all these threshold functions into account a effe~ tire scheme is to form the convex combination of them as the global tl 'eshold, that is the global threshold ¢ is given by

qb~ Ci~ i "--~'-C2¢2 "}- "
k
• ci~ l
i:l

ck~k

where cl > 0 for every i. Each ci provides a weight for its corresponding threshold function so that the total strategy can undergo tuning.

W h a t are the useful threshold functions? We have found a few~ but it is clear that the number of useful criteria left to be discovered is many. Among the threshold functions we have found useful axe 1) the uniform sampling threshold; 2} The totally r a n d o m threshold (~b = .5); 3) The difference of integrals of the two subnodes; 4) A history of the activity of change in this subnode (which may be the varianc% or some
weighted time history of the integral); and 5) A priori functions that can predict where large illumination components will be.

So far our experiments in finding adaptive criteria have not been terribly successful. We have not ~sed adaptation in computing the final images.

Again we note as in the last section, that recording the volumes of the cells in each node automatically provides the normal~ation that is needed when the sampling distribution is skewed. This is often problematical in adaptive sampling schemes.

Figure 4 shows the unit square subdivided according to criterion 1) and 3) in equal proportion. This is a snapshot of the subdivision when 165 samples have been ca~st.

Nonuniform sampling: Importance sampling analogs

Finally, the fifth technique takes into account importance sampling. Instead of dividing a leaf cell exactly in half, it is possible to divide it along a hyperplane that represents the median of some probability density function. The hyperplane chosen is given by the level of the k-d tree in the second technique. Representing the probability density as an integrated distribution function makes it easy to choose the median hyperplane by a quick binary search: to find the median of a probability density jr(x) we simply search for the point at which
r(x) = ,5.
Importance sampling is a very important variance reduction technique which can be used to great advantage in solving the rendering equation.

6. Application to the r e n d e r i n g equation
The monte carlo algorithms presented above can all be applied to a solution of the rendering algorithm. For example, sequential uniform sampling is used to sample the aperture for depth of field blur. Adaptive hierarchical integration is used to subsample the pixel. Importance sampling by splitting along the medians is used in choosing a direction to shoot the next ray. We store the lighting model as a summed area table [Crow 1985], giving a probability distribution function which can undergo binary search to find the median in a reflectance cell. Since we search for a median hyperplane of the lighting model, nonlinear transformations of the domain are not particularly important. We simply project the pair of input and output hemispheres onto the tangent plane.
It is interesting to compare the path solution to the conventional ray tracing algorithm. It is in fact quite easy to convert a conventional ray tracer to this algorithm. W e essentially perform a conventional ray tracing algorithm, but instead of branching a tree of rays at each surface, we follow only one of the branches to give a path in the tree. W e always shoot toward known light sources, which, of course, m a y be extended areas. Thus a schematic of ray tracing versus the integral equation method appears thus:

I

\\d J \

Now an important phenomenon is pointed out by this diagram. Due to the passivity of surfaces, it is widely known that the first generation rays as well as the light source rays are the most important to in terms of variance that they contribute to the pixel integral. Second and higher generation rays contribute much less to the variance. But conventional ray tracing expends the vast bulk of the work on precisely those rays which contribute least to the variance of the image, it shoots too many rays of higher generations. The integral equation method is not prone to this criticism. Because a path is a tree with branching ratio lj there are as many different first generation rays as there are higher generation rays. This is very important for variance reduction for motion blur, depth of field, and other effects in distributed ray tracing.
This diagram also points out an alternative algorithm for conventional distributed ray tracing. Rather than shooting a branching tree, just shoot a path with the rays chosen probabillstically. For scenes with much reflection and refraction, this cuts down vastly on the number of ray object intersections to be computed for a given plxel and performs a remarkable speed up of ray tracing for very little programming work. However, for this new fast form of ray tracing----called path tracing--we have found that it is very important to maintain the correct proportion of reflection, refraction, and shadow ray types contributing to each pixel. Rather than choosing the ray type randomly, there are two alternatives. First, keep track of of the number of each type shot. Make sure the sample distribution of ray types closely matches the desired distribution by varying the the probability of each type so that it is more certain that the sample distribution matches. This is the approach we have actually implemented. A second approach is to let the ray types be chosen randomly but to scale the contribution of each ray type by the ratio of desired distribution to the resulting weighted sample distribution.

148

Dallas, August 18-22

Volume 20, Number 4, 1986

7. P,.esult s
Figures 5 and 6 show resulting images from the integral equation technique. At each surface element hit, a random variable was calculated from o. distribution determined by the specular, diffuse, and transmission coefficients. This random variable was used to choose the shooting of one ray from the surface element. A random point was chosen on each light source to serve as a target for.an illumination ray. The variance reduction methods actually used were multidimensional sequential sampling for choosing the diffuse direction, specular direction, and refracted direction of a new ray. Multidimensional sequential sampling was also used to choose points on the light sources and imaging aperture. Hierarchical integration was used for antialiasing the pixel values. No adaptive or nonuniform sampling was used for either of these images. It is clear that importance sampling would improve the variance of the image considerably. Although implementation of importance sampling is simple and straightforward it has not yet been done. Also, keeping track of the variance of each pixel and collecting sequential has shown to be a significant speed up. However, our program did not do this for these images, we shot a constant 40 paths per plxel.
Figure 5 shows a model rendered via two techniques. On the left side is the model rendered via the standard ray tracing technique (albeit with ambient coefficientset to 0 ~nd the single branching ratio speedup mentioned above). The right image shows the result of rendering via the integral equation. Both images are 256 by 256 pixele with a fixed 40 paths per pixel. The images were computed on an IBM-4341. The first image took 401 minutes of C P U time, the second image took 533 minutes. Note that the area of the sphere in shadow is picking up ambient illumination missing in the ray tracing picture. Also light is bouncing off the bottom of the sphere and lighting up the base plane.
In figure 6 we show an image illustrating the power of the integral equation technique. All objects in the scene are a neutral grey except for the green glass bails and the base polygon (which is slightly reddish). A n y color on the grey objects would be missing from a ray tracing image. Note that the green glass balls cast caustics on objects" in the scene. There is color bleeding from the lightly colored base polygon onto the bottom of the oblate spheroid in the upper right. For simplicity and comparison purposes, the opaque surfaces in this scene are lambertian, but there is no restriction on the lighting models that can be used. Figure 6 is a 512 by 512 pixel image with 40 paths per pixel. It was computed on an I B M 3081 and consumed 1221 minutes of C P U time. Al Burr provided the model for this image.
A C K N O W L E D G M E N T S Thanks to Al Burr, Tim Kay, RobCook, Jim Bllnn, and the members of CS286 Computer Graphics Seminar, for technical discussions. I am grateful to IBM, Juan Rivero of the Los Angeles Science Center and Alan Norton of Yorktown Heights Research for donating large numbers of mainframe cycles to Caltech. I also wish to thank the reviewers for their many thoughtful comments.
References
J.L. BENTLEY, J.H. F R I E D M A N aData structures for range searching", A C M Comp. Surv., 11,4j pp.397-409., 1979.
S. CHANDRASEKAR Radiative Transfer, Oxford University Press, 1950. M . F . COHEN, D . P . GREENBURG aTheHeml-cube: a Radiosltysolu-
tiou for complex environments~, Computer Graphics 19,3, pp.3140, 1985. R.L. C O O K , T. P O R T E R , L C A R P E N T E R "Distributed ray tracing~, Computer GraphicelS,3, pp.137-146,1984. R.L. C O O K , aStochastic sampling in computer graphics~, to appear in A C M Transactions of Graphics
R. COURANT AND D. HILBERT, Methods el mathematics! physics 2
vols., Interscience, New York 1953, 1962. F . C . CROW ~Summed area tables for texture mapping~, Computer
Graphics 18,3, pp.207-212, 1984. R . P . FEYNMAN AND A . P . HIBBS Quantum Mechanics and Path In-
tegrals, McGraw-Hill, New York 19B5. H. G O L D g T E I N ClassicalMechanics Addlson-Weeley, Reading, Ma~s.
1950. C. M . C O R A L , K . E . T O R R A N C E , D.P. G R E E N B U R G "qk.lodei-

ing the interaction of light between diffuse surfaces', Computer Graphics 18,3, pp.213..222, 1984. I . H . HALTON aA retrospective and prospective survey of the monte carlo methodm, SIAM Roy. 12, pp.1-63, 1970. J . T . KAJIYAj B. VON HEKZEN ~Rsy tracing volume densitites~, Computer Graphics 18,3, pp.165-174, 1984. M . E . LEE, R . A . REDNER, S . P . USELTONuStatistieally Optimized Sampling for distributed ray tracingJ Computer graphics v.19,3 pp.61-67. T. NISHITA, E. N A K A M A E "Continuous tone repre~entatlon of three dimensional objects taking account of shadows and interreflection", Computer CIraphics19,3, pp.23-30, 1985. n . Y . RUBENSTEIN Simulation and the Monte Carlo Aifethoa~ J.Wiley, New York~ 1981. R. SIEGEL, J . R . HOWELL Thermal Radiation Heat Trar~sfcr, McGraw Hill, New York, 1981. T . WHITTED •An improved illumination model for shaded display', Comm. ACM, 23,6, pp.343-349, June 10.80. S. "YAKOWITZ, st. al. "Weighted monte carlo integration~ , S I A M J. Num. An. 15,15,pp.1289-1300, 1978.
Figure 3. Convergence of naleve monte carlo vs. hieraxchical integration. Shown are integral estlmat~ az a function of number of samples ¢~t. Naleve monte carlo is the top curve.
Figure 4. Subdivision of domain by adaptive hierarchical integration.

149

m

S I G G R A P H '86

Figure 5. A comparison of ray tracing vs. integralequation technlque. Note the presence of lighton the base polygon scattered by the sphere from the light source.

150

Figure 6. A sample image. All objects are neutral grey. Color on the objects isdue to causticsfrom the green glassballsand color bleeding from the base polygon.

