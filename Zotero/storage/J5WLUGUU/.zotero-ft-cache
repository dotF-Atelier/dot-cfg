Understanding the Masking-Shadowing Function in Microfacet-Based BRDFs Eric Heitz
INRIA ; CNRS ; Univ. Grenoble Alpes

2014-09-01

Understanding the Masking-Shadowing Function in Microfacet-Based BRDFs

Understanding the Masking-Shadowing Function in Microfacet-Based BRDFs Eric Heitz
INRIA ; CNRS ; Univ. Grenoble Alpes

→ 2014-09-01 →

Introduction Physically Based Shading in Theory and Practice

Microfacet theory

microfacet normals

Understanding the Masking-Shadowing Function in Microfacet-Based BRDFs

Physically Based Shading in Theory and Practice

Microfacet theory

microfacet normals

In this section of the course, I will be reviewing the theoretical aspects of physically based shading, and microfacet theory in particular.

1

2014-09-01

Introduction

Understanding the Masking-Shadowing Function in Microfacet-Based BRDFs

2

Introduction

2014-09-01

Understanding the Masking-Shadowing Function in Microfacet-Based BRDFs
Microfacet theory is fundamental to the design of physically based shading models.
3

Introduction

2014-09-01

Understanding the Masking-Shadowing Function in Microfacet-Based BRDFs
But it is not only limited to that. It is used in other applications, such as fabrication...
4

Introduction

2014-09-01

Understanding the Masking-Shadowing Function in Microfacet-Based BRDFs
...or inverse scattering problems.
5

Introduction

2014-09-01

Understanding the Masking-Shadowing Function in Microfacet-Based BRDFs
Ideally, these applications would build on a perfect descriptor of real-world scattering.
6

Introduction

2014-09-01

Understanding the Masking-Shadowing Function in Microfacet-Based BRDFs
But this is either too complicated or impossible.
7

Introduction

2014-09-01

Understanding the Masking-Shadowing Function in Microfacet-Based BRDFs
So instead we use microfacet theory as an approximation of real-world scattering. Of course, as an approximation, it comes with several limitations.
8

Introduction

2014-09-01

Understanding the Masking-Shadowing Function in Microfacet-Based BRDFs
The ﬁrst and most obvious limitation is that microfacet theory is, and ever will be, a subset of real-world scattering: there are some materials that cannot be described by microfacet theory. But this is reasonable, as we cannot expect a single theory to describe the entire universe.
9

Introduction

2014-09-01

Understanding the Masking-Shadowing Function in Microfacet-Based BRDFs
Another, more serious limitation, is that some so-called “microfacet models” are actually mathematically inconsistent.
10

Introduction

2014-09-01

Understanding the Masking-Shadowing Function in Microfacet-Based BRDFs
A further diﬃculty is that we now have so many microfacet models in the ﬁeld of computer graphics that understanding how they are connected together is not always obvious.
11

Introduction

2014-09-01

Understanding the Masking-Shadowing Function in Microfacet-Based BRDFs
So, microfacet theory is far from perfect, but it is still one of the best tools we have at our disposal for investigating surface scattering. This is why it is important to keep studying and improving it.
12

Associated paper

Introduction

2014-09-01

Understanding the Masking-Shadowing Function in Microfacet-Based BRDFs

Associated paper

Motivation: improving our understanding and validation of microfacet models
This JCGT paper serves as the course notes for this talk and we refer the reader to this paper for the derivations of the equations presented in the slides. The main motivation behind the paper is to improve how we choose and validate microfacet models. We will see that this is closely related to the choice of masking function.

Motivation: improving our understanding and validation of microfacet models 13

Introduction
Another related paper
Importance Sampling Microfacet-Based BSDFs using the Distribution of Visible Normals Eric Heitz & Eugene d’Eon EGSR 2014
→ a practical follow up of the theoretical knowledge presented in this course

2014-09-01

Understanding the Masking-Shadowing Function in Microfacet-Based BRDFs

Another related paper
Importance Sampling Microfacet-Based BSDFs using the Distribution of Visible Normals Eric Heitz & Eugene d’Eon EGSR 2014
→ a practical follow up of the theoretical knowledge presented in this course

This paper will not be discussed in this talk, but is a practical follow up of its theoretical content. It is a typical example of how theoretical investigations can have practical consequences: by using our understanding of the microfacet model, we were able to design a new importance sampling technique for microfacet BSDFs.

14

Introduction

Previous: 512 spp (88.9s)

Ours: 408 spp (87.1s)

2014-09-01

Understanding the Masking-Shadowing Function in Microfacet-Based BRDFs

Previous: 512 spp (88.9s)

Ours: 408 spp (87.1s)

A dielectric glass plate (n = 1.5) with anisotropic Beckmann roughness (αx = 0.05, αy = 0.4). same rendering time
Results from the EGSR sampling paper: for the same rendering time, our technique produces images with less variance.

A dielectric glass plate (n = 1.5) with anisotropic Beckmann roughness (αx = 0.05, αy = 0.4).
same rendering time 15

2014-09-01

Understanding the Masking-Shadowing Function in Microfacet-Based BRDFs

Overview of Microfacet Theory and Related Problems

Overview of Microfacet Theory and Related Problems

16

Overview of Microfacet Theory and Related Problems

2014-09-01

Understanding the Masking-Shadowing Function in Microfacet-Based BRDFs
To get started, I will give you an overview of how microfacet theory is constructed.

17

Overview of Microfacet Theory and Related Problems

2014-09-01

Understanding the Masking-Shadowing Function in Microfacet-Based BRDFs
While the geometric surface (or macrosurface) may appear ﬂat, microfacet theory assumes that a very small and rough microsurface is responsible for the scattering occurring at the material interface. The ﬁrst step is to model the geometry of this microsurface, in other words: what does it look like?

18

Overview of Microfacet Theory and Related Problems

2014-09-01

Understanding the Masking-Shadowing Function in Microfacet-Based BRDFs
Once the geometry of the microsurface has been established, we can compute what parts of it will be visible for a given view direction.

19

Overview of Microfacet Theory and Related Problems

2014-09-01

Understanding the Masking-Shadowing Function in Microfacet-Based BRDFs
Once we know what parts of the microsurface are visible, we need to model how they will be interacting with the light. Usually, microfacet models assume that the microfacets are perfectly specular and produce mirror-like reﬂections. Other models, like Oren and Nayar’s, assume that the microfacets are perfect diﬀusers.

20

Overview of Microfacet Theory and Related Problems

2014-09-01

Understanding the Masking-Shadowing Function in Microfacet-Based BRDFs
Once the microsurface geometry, visibility and material are ﬁxed, we can ﬁnally derive the complete microsurface BRDF expression. In the case of specular microfacets, this leads to the famous Cook and Torrance equation.

21

Overview of Microfacet Theory and Related Problems

2014-09-01

Understanding the Masking-Shadowing Function in Microfacet-Based BRDFs
In common microfacet papers, the ﬁrst three derivation steps are considered “previous work”, and the Cook and Torrance equation usually serves as the starting point from which to derive new models. By modifying F , G2 and D, it is possible to create a wide variety of diﬀerent models.

22

Overview of Microfacet Theory and Related Problems

2014-09-01

Understanding the Masking-Shadowing Function in Microfacet-Based BRDFs
Once a new model has been created, it has to be validated.

23

Overview of Microfacet Theory and Related Problems

2014-09-01

Understanding the Masking-Shadowing Function in Microfacet-Based BRDFs
We usually consider a microfacet model to be “physically based” if it is positive, reciprocal, and energy conserving.

24

Overview of Microfacet Theory and Related Problems

2014-09-01

Understanding the Masking-Shadowing Function in Microfacet-Based BRDFs
However, those criteria are not suﬃcient to validate a new model, because they are not restrictive enough. Intuitively, one could come up with some random BRDF model that easily satisﬁes those three conditions, and yet fails to relate to any meaningful physical model.

25

Overview of Microfacet Theory and Related Problems

2014-09-01

Understanding the Masking-Shadowing Function in Microfacet-Based BRDFs
What’s missing? The problem is that these intermediate derivation steps have also their own validation criteria. However, since they are almost never mentioned, these associated criteria are almost never checked.

26

Overview of Microfacet Theory and Related Problems

2014-09-01

Understanding the Masking-Shadowing Function in Microfacet-Based BRDFs
It turns out that, within the set of what we call “microfacet models” today, there are some that don’t validate those criteria. Such models should not be called “microfacet based”, nor “physically based”.

27

Overview of Microfacet Theory and Related Problems

2014-09-01

Understanding the Masking-Shadowing Function in Microfacet-Based BRDFs
This is probably the main message of this talk.

28

Overview of Microfacet Theory and Related Problems

2014-09-01

Understanding the Masking-Shadowing Function in Microfacet-Based BRDFs
The objective of this presentation (and the course notes) is to review those derivations and for each one determine the associated validation criteria. Then, we will use them to assess common models.

29

The microfacet model

2014-09-01

Understanding the Masking-Shadowing Function in Microfacet-Based BRDFs

The microfacet model

30

The microfacet model The geometric surface

2014-09-01

Understanding the Masking-Shadowing Function in Microfacet-Based BRDFs

The geometric surface

Microfacet theory starts with the geometric surface. In the case of a triangle mesh that we wish to shade, the “geometric surface” refers to a very small and locally planar piece of this mesh. Its area is 1 by convention.

31

The microfacet model The microsurface

2014-09-01

Understanding the Masking-Shadowing Function in Microfacet-Based BRDFs

The microsurface

Next, we assume that what is actually interacting with the light is not the geometric surface, but a rough microsurface, composed of microfacets. At this point, the scattering occurring at the object interface can be described as a spatial function deﬁned on the microsurface.

32

The microfacet model The distribution of normals D(ωm)

2014-09-01

Understanding the Masking-Shadowing Function in Microfacet-Based BRDFs

The distribution of normals D(ωm)

However, working with a spatial description of the problem is needlessly complicated. It is much easier to use a statistical description that’s deﬁned on the sphere. This is what the distribution of normals is for: it relates a spatial measure deﬁned on the microsurface to a statistical measure deﬁned on the sphere.
This slide is animated (works with Acrobat Reader).

33

The microfacet model The distribution of normals D(ωm)

2014-09-01

Understanding the Masking-Shadowing Function in Microfacet-Based BRDFs

The distribution of normals D(ωm)

The integral of the distribution of normals is the area of the microsurface
As a consequence, the measure of the entire distribution of normals (its integral) is the measure of the entire microsurface (its area).

The integral of the distribution of normals is the area of the microsurface 34

The microfacet model The distribution of normals D(ωm)

2014-09-01

Understanding the Masking-Shadowing Function in Microfacet-Based BRDFs

The distribution of normals D(ωm)

The projected area of the microsurface onto the geometric normal is 1 (ωm · ωg ) D(ωm) d ωm = 1
Ω
Since the distribution of normals is a statistical descriptor of the microsurface, it should precisely obey the same properties. The ﬁrst property is the conservation of the projected area: the microsurface projected onto the geometric surface is the geometric surface, and so the projected area of the microsurface is the area of the geometric surface (1 by convention, as mentioned earlier).
This slide is animated (works with Acrobat Reader).

The projected area of the microsurface onto the geometric normal is 1

(ωm · ωg ) D(ωm) d ωm = 1

Ω

35

Validation equations
Classic: positivity, reciprocity, energy conservation

Ω

G1(ωo , ωh) D(ωh) 4 cos θo

d

ωi

=

1

Dωo (ωm) d ωm = 1
Ω
G1(ωo , ωm)〈ωo , ωm〉 D(ωm) d ωm = cos θo
Ω
(ωm · ωg ) D(ωm) d ωm = 1
Ω

2014-09-01

Understanding the Masking-Shadowing Function in Microfacet-Based BRDFs
We can use this property for validation.
36

Classic: positivity, reciprocity, energy conservation

Ω

G1(ωo , ωh) D(ωh) 4 cos θo

d

ωi

=

1

Dωo (ωm) d ωm = 1 Ω G1(ωo , ωm)〈ωo , ωm〉 D(ωm) d ωm = cos θo Ω
(ωm · ωg ) D(ωm) d ωm = 1 Ω

The microfacet model Conservation of the projected area
projected area =
cos θo

2014-09-01

Understanding the Masking-Shadowing Function in Microfacet-Based BRDFs

Conservation of the projected area

projected area =
cos θo
We can generalize the concept of the projected area to any direction. The projected area of the geometric surface is the cosine of the projection direction.

37

The microfacet model Conservation of the projected area

2014-09-01

Understanding the Masking-Shadowing Function in Microfacet-Based BRDFs

Conservation of the projected area

projected area =
cos θo

projected area =
cos θo

If we replace the geometric surface by the microsurface in this ﬁgure, it may appear that the projected area doesn’t change. However, this is only because the microsurface features are small.

projected area =
cos θo

projected area

=

cos θo

38

The microfacet model Conservation of the projected area

2014-09-01

Understanding the Masking-Shadowing Function in Microfacet-Based BRDFs

Conservation of the projected area

projected area =
cos θo

projected area =
Ω G1(ωo , ωm)〈ωo , ωm〉 D(ωm) d ωm

By zooming into the microsurface, we can see that its projected area is the sum of the projected areas of the microfacets that are visible. At this point, we need to introduce a visbility term, G1, to discard the microfacets that are occluded. This is the masking function. Thanks to this masking function, we can write a new equation.

projected area =
cos θo

projected area

=

Ω G1(ωo , ωm)〈ωo , ωm〉 D(ωm) d ωm

39

Validation equations
Classic: positivity, reciprocity, energy conservation

Ω

G1(ωo , ωh) D(ωh) 4 cos θo

d

ωi

=

1

Dωo (ωm) d ωm = 1
Ω
G1(ωo , ωm)〈ωo , ωm〉 D(ωm) d ωm = cos θo
Ω
(ωm · ωg ) D(ωm) d ωm = 1
Ω

2014-09-01

Understanding the Masking-Shadowing Function in Microfacet-Based BRDFs
We can add this equation to our validation list.
40

Classic: positivity, reciprocity, energy conservation

Ω

G1(ωo , ωh) D(ωh) 4 cos θo

d

ωi

=

1

Dωo (ωm) d ωm = 1 Ω G1(ωo , ωm)〈ωo , ωm〉 D(ωm) d ωm = cos θo Ω
(ωm · ωg ) D(ωm) d ωm = 1 Ω

The microfacet model The distribution of visible normals Dωo (ωm)

2014-09-01

Understanding the Masking-Shadowing Function in Microfacet-Based BRDFs

The distribution of visible normals Dωo (ωm)

As we have seen, the microsurface is described by the distribution of normals.

41

The microfacet model The distribution of visible normals Dωo (ωm)

2014-09-01

Understanding the Masking-Shadowing Function in Microfacet-Based BRDFs

The distribution of visible normals Dωo (ωm)

View rays can only intersect normals that are visible
However, only the microfacets that are visible will reﬂect light towards the viewer. Incorporating visibility into the distribution gives us the distribution of visible normals. If the model is well designed, this distribution should be normalized, in the sense that the percentages shown in the ﬁgure should add up to exactly 1.

View rays can only intersect normals that are visible

42

Validation equations
Classic: positivity, reciprocity, energy conservation

Ω

G1(ωo , ωh) D(ωh) 4 cos θo

d

ωi

=

1

Dωo (ωm) d ωm = 1
Ω
G1(ωo , ωm)〈ωo , ωm〉 D(ωm) d ωm = cos θo
Ω
(ωm · ωg ) D(ωm) d ωm = 1
Ω

2014-09-01

Understanding the Masking-Shadowing Function in Microfacet-Based BRDFs
43

Classic: positivity, reciprocity, energy conservation

Ω

G1(ωo , ωh) D(ωh) 4 cos θo

d

ωi

=

1

Dωo (ωm) d ωm = 1 Ω G1(ωo , ωm)〈ωo , ωm〉 D(ωm) d ωm = cos θo Ω
(ωm · ωg ) D(ωm) d ωm = 1 Ω

The microfacet model The distribution of reﬂected directions

2014-09-01

Understanding the Masking-Shadowing Function in Microfacet-Based BRDFs

The distribution of reﬂected directions

View rays can only intersect normals that are visible
If we return to this ﬁgure that shows the microfacets that are visible...

View rays can only intersect normals that are visible

44

The microfacet model The distribution of reﬂected directions

2014-09-01

Understanding the Masking-Shadowing Function in Microfacet-Based BRDFs

The distribution of reﬂected directions

Reﬂection

by

visible

normals:

ρ(ωo , ωi ) =

G1(ωo , ωh) D(ωh) 4 cos θo cos θi

...and apply a light transport operator such as specular reﬂection, we get the equation of an incomplete BRDF model. At this point in the model, no energy is lost, and we can see that the distribution of reﬂected directions (the percentages in orange) exactly matches the distribution of visible microfacets (the percentages in black). Hence, this incomplete BRDF model should be normalized as well.

Reﬂection

by

visible

normals:

ρ(ωo , ωi ) =

G1(ωo , ωh) D(ωh) 4 cos θo cos θi

45

Validation equations
Classic: positivity, reciprocity, energy conservation

Ω

G1(ωo , ωh) D(ωh) 4 cos θo

d

ωi

=

1

Dωo (ωm) d ωm = 1
Ω
G1(ωo , ωm)〈ωo , ωm〉 D(ωm) d ωm = cos θo
Ω
(ωm · ωg ) D(ωm) d ωm = 1
Ω

2014-09-01

Understanding the Masking-Shadowing Function in Microfacet-Based BRDFs

Classic: positivity, reciprocity, energy conservation

Ω

G1(ωo , ωh) D(ωh) 4 cos θo

d

ωi

=

1

Dωo (ωm) d ωm = 1 Ω G1(ωo , ωm)〈ωo , ωm〉 D(ωm) d ωm = cos θo Ω
(ωm · ωg ) D(ωm) d ωm = 1 Ω

We have established validation criteria for these three intermediate steps. We can now derive the entire BRDF expression by adding the missing terms.

46

The microfacet model The Fresnel term

2014-09-01

Understanding the Masking-Shadowing Function in Microfacet-Based BRDFs

The Fresnel term

In this ﬁgure we assumed a perfect specular reﬂection.

Reﬂection

by

visible

normals:

ρ(ωo , ωi ) =

G1(ωo , ωh) D(ωh) 4 cos θo cos θi

Reﬂection

by

visible

normals:

ρ(ωo , ωi ) =

G1(ωo , ωh) D(ωh) 4 cos θo cos θi

47

The microfacet model The Fresnel term

2014-09-01

Understanding the Masking-Shadowing Function in Microfacet-Based BRDFs

The Fresnel term

Reﬂection

and

transmission

by

visible

normals:

ρ(ωo , ωi ) =

F (ωo , ωh) G1(ωo , ωh) D(ωh) 4 cos θo cos θi

However, on a physical surface, only some of the energy is reﬂected. The rest is either transmitted or absorbed. This is modeled by introducing the Fresnel term F into the equation.

Reﬂection

and

transmission

by

visible

normals:

ρ(ωo , ωi ) =

F (ωo , ωh) G1(ωo , ωh) D(ωh) 4 cos θo cos θi

48

The microfacet model The shadowing function

2014-09-01

Understanding the Masking-Shadowing Function in Microfacet-Based BRDFs

The shadowing function

Only one component of the model is missing: most of the rays leave the surface...
We are now very close to the ﬁnal model. However, one compenent is still missing, and this is because, after the reﬂection some of the rays will leave the surface...

Only one component of the model is missing: most of the rays leave the surface...
49

The microfacet model The shadowing function

...but others will be occluded (microsurface shadowing)

ρ(ωo

, ωi

)

=

F

(ωo

,

ωh)G1(ωo ,ωh) G2(ωo 4 cos θo cos θi

,

ωi

,

ωh) D(ωh)

2014-09-01

Understanding the Masking-Shadowing Function in Microfacet-Based BRDFs

The shadowing function

...but others will be occluded (microsurface shadowing)

ρ(ωo , ωi )

=

F

(ωo , ωh)G1(ωo ,ωh) G2(ωo , ωi , ωh) D(ωh) 4 cos θo cos θi

...but others will be occluded, i.e., they will intersect the surface a second time. This is called microsurface shadowing. To incorporate this eﬀect into the model, we replace the masking function G1, which represents visibility for the outgoing direction only, by a masking-shadowing function, G2, which represents simultaneous visibility for the outgoing and incident directions.

50

The microfacet model

The complete microfacet BRDF model

ρ(ωo

, ωi

)

=

F

(ωo

,

ωh) G2(ωo 4 cos θo

, ωi , ωh) D(ωh) cos θi

Validation? Positivity ρ(ωo, ωi ) > 0 Reciprocity ρ(ωo , ωi ) = ρ(ωi , ωo ) Energy conservation ρ(ωo, ωi ) cos θi d ωi ≤ 1
Ω

Very weak conditions. Inappropriate for validation!

2014-09-01

Understanding the Masking-Shadowing Function in Microfacet-Based BRDFs

The complete microfacet BRDF model

ρ(ωo , ωi )

=

F

(ωo , ωh) G2(ωo , ωi , ωh) D(ωh) 4 cos θo cos θi

Validation? Positivity ρ(ωo, ωi ) > 0 Reciprocity ρ(ωo , ωi ) = ρ(ωi , ωo ) Energy conservation ρ(ωo, ωi ) cos θi d ωi ≤ 1 Ω

Very weak conditions. Inappropriate for validation!

We have now derived the complete BRDF model. Since the last terms we introduced – Fresnel and shadowing – are responsible for energy loss, the strict validation equations we had at the beginning have disappeared, and what is left is only a weak inequality, which is not very appropriate for thorough validation.

51

Validation equations
Classic: positivity, reciprocity, energy conservation

Ω

G1(ωo , ωh) D(ωh) 4 cos θo

d

ωi

=

1

Dωo (ωm) d ωm = 1
Ω
G1(ωo , ωm)〈ωo , ωm〉 D(ωm) d ωm = cos θo
Ω
(ωm · ωg ) D(ωm) d ωm = 1
Ω

2014-09-01

Understanding the Masking-Shadowing Function in Microfacet-Based BRDFs

Classic: positivity, reciprocity, energy conservation

Ω

G1(ωo , ωh) D(ωh) 4 cos θo

d

ωi

=

1

Dωo (ωm) d ωm = 1 Ω G1(ωo , ωm)〈ωo , ωm〉 D(ωm) d ωm = cos θo Ω
(ωm · ωg ) D(ωm) d ωm = 1 Ω

However, on the way towards the ﬁnal model, we have gathered several useful equations. We will now use them to assess common models.

52

Review of Common Distributions of Normals

2014-09-01

Understanding the Masking-Shadowing Function in Microfacet-Based BRDFs

Review of Common Distributions of Normals

53

Validation equations
Classic: positivity, reciprocity, energy conservation

Ω

G1(ωo , ωh) D(ωh) 4 cos θo

d

ωi

=

1

Dωo (ωm) d ωm = 1
Ω
G1(ωo , ωm)〈ωo , ωm〉 D(ωm) d ωm = cos θo
Ω
(ωm · ωg ) D(ωm) d ωm = 1
Ω

2014-09-01

Understanding the Masking-Shadowing Function in Microfacet-Based BRDFs

Classic: positivity, reciprocity, energy conservation

Ω

G1(ωo , ωh) D(ωh) 4 cos θo

d

ωi

=

1

Dωo (ωm) d ωm = 1 Ω G1(ωo , ωm)〈ωo , ωm〉 D(ωm) d ωm = cos θo Ω
(ωm · ωg ) D(ωm) d ωm = 1 Ω

This equation can be used to validate distributions of normals.

54

Review of Common Distributions of Normals Common distributions of normals

Name Blinn-Phong

Validation? “physically based”?





Normalized Blinn-Phong





Ward





Beckmann





GGX





2014-09-01

Understanding the Masking-Shadowing Function in Microfacet-Based BRDFs

Common distributions of normals

Name Blinn-Phong

Validation? “physically based”?





Normalized Blinn-Phong





Ward





Beckmann





GGX





Here are some examples (not exhaustive) of common distributions of normals. We can see, for instance, that the old Blinn-Phong and Ward distributions are not appropriately normalized.

55

Review of Common Masking Functions

2014-09-01

Understanding the Masking-Shadowing Function in Microfacet-Based BRDFs

Review of Common Masking Functions

56

Validation equations
Classic: positivity, reciprocity, energy conservation

Ω

G1(ωo , ωh) D(ωh) 4 cos θo

d

ωi

=

1

Dωo (ωm) d ωm = 1
Ω
G1(ωo , ωm)〈ωo , ωm〉 D(ωm) d ωm = cos θo
Ω
(ωm · ωg ) D(ωm) d ωm = 1
Ω

2014-09-01

Understanding the Masking-Shadowing Function in Microfacet-Based BRDFs

Classic: positivity, reciprocity, energy conservation

Ω

G1(ωo , ωh) D(ωh) 4 cos θo

d

ωi

=

1

Dωo (ωm) d ωm = 1 Ω G1(ωo , ωm)〈ωo , ωm〉 D(ωm) d ωm = cos θo Ω
(ωm · ωg ) D(ωm) d ωm = 1 Ω

We can use these two equations to validate masking functions.

57

Review of Common Masking Functions Common masking functions

Name Smith

Validation? “physically based”?





Cook & Torrance V-cavities





Implicit





Kelemen





Schlick-Smith





2014-09-01

Understanding the Masking-Shadowing Function in Microfacet-Based BRDFs

Common masking functions

Name Smith

Validation? “physically based”?





Cook & Torrance V-cavities





Implicit





Kelemen





Schlick-Smith





There are a lot of diﬀerent masking functions in the literature. To my knowledge, only two of them satisfy the validation equations: the Smith and V-cavity masking functions. This is because they are both based on a microsurface model. The others should not be called “physically based”, in the sense that there is no possible microsurface model from which they can be derived.

58

Review of Common Masking Functions Comparison with measured BRDFs

Understanding the Masking-Shadowing Function in Microfacet-Based BRDFs

Comparison with measured BRDFs

2014-09-01

Since the Smith and V-cavity masking functions are both mathematically correct but make diﬀerent assumptions about the microsurface, we may wonder which one is the most accurate compared to measured data on a continuous, random Gaussian surface. To ﬁnd out, we can generate such a surface using a noise primitive with Gaussian statistics (Gabor Noise is a good choice). We can then subject this to a raytracing simulation and record the outgoing directions. This gives us a plot of the measured BRDF. Finally, we can compare this against an analytical BRDF model with a compatible Beckmann distribution (parameterized by the Gaussian statistics of the microsurface) and a given masking function.
59

Review of Common Masking Functions

Comparison with measured BRDFs

Roughness

V-cavity BRDF Smith BRDF Measured BRDF

α = 0.4

α = 0.7

2014-09-01

Understanding the Masking-Shadowing Function in Microfacet-Based BRDFs

Comparison with measured BRDFs

Roughness

V-cavity BRDF Smith BRDF Measured BRDF

α = 0.4

α = 0.7

α = 1.0

We can see that the BRDF predicted by the model with the Smith masking function is much closer to the measured BRDF than the BRDF predicted by the V-cavity masking function.

α = 1.0 60

State of the Art Microfacet Models

2014-09-01

Understanding the Masking-Shadowing Function in Microfacet-Based BRDFs

State of the Art Microfacet Models

61

State of the Art Microfacet Models Widely used in production and academia nowadays
Beckmann distribution & Smith masking function GGX distribution & Smith masking function

2014-09-01

Understanding the Masking-Shadowing Function in Microfacet-Based BRDFs

Widely used in production and academia nowadays Beckmann distribution & Smith masking function GGX distribution & Smith masking function

The Beckmann and GGX distributions, with their associated masking functions, are considered state of the art in academia today. They are also the most widely used in the video game and visual eﬀects industries.

62

State of the Art Microfacet Models Widely used in production and academia nowadays
Isotropic Beckmann distribution & Smith masking function Isotropic GGX distribution & Smith masking function → Physically based anisotropy?

2014-09-01

Understanding the Masking-Shadowing Function in Microfacet-Based BRDFs

Widely used in production and academia nowadays Isotropic Beckmann distribution & Smith masking function Isotropic GGX distribution & Smith masking function
→ Physically based anisotropy?

Despite existing for a long time, they were introduced and popularized in CG by Walter et al. in their famous EGSR’07 paper. However, those distributions only model isotropic microsurfaces. It is therefore natural to ask: “can they be extended to anisotropic microsurfaces, whilst retaining their physical properties?”

62

Anisotropy and Stretch Invariance

2014-09-01

Understanding the Masking-Shadowing Function in Microfacet-Based BRDFs

Anisotropy and Stretch Invariance

63

Anisotropy and Stretch Invariance

2014-09-01

Understanding the Masking-Shadowing Function in Microfacet-Based BRDFs
Beckmann & GGX: microfacet normals ⇔ microsurface slope
The ﬁrst step towards anisotropy is to understand the meaning of the roughness parameters αx and αy . The Beckmann and GGX distributions have an associated microsurface heightﬁeld, where the normals are given by the slopes of the heightﬁeld.

Beckmann & GGX: microfacet normals ⇔ microsurface slope 64

Anisotropy and Stretch Invariance

2014-09-01

Understanding the Masking-Shadowing Function in Microfacet-Based BRDFs
Beckmann & GGX: scaling the roughness ⇔ stretching the microsurface
The roughness parameters model how much the heightﬁeld is stretched. For instance, dividing the roughness αx by a factor of 2 is equivalent to stretching the microsurface by a factor of 2 in the x direction.

Beckmann & GGX: scaling the roughness ⇔ stretching the microsurface 65

Anisotropy and Stretch Invariance Anisotropic Beckmann Distribution

1 D(ωm, αx , αy ) = π αx αy cos4 θm exp

− tan2 θm

cos2 φm α2x

+

sin2 φm α2y

Anisotropic GGX Distribution

1

D(ωm, αx , αy ) = (π αx αy cos4 θm)

1 + tan2 θm

cos2 φm α2x

+

sin2 φm α2y

2

2014-09-01

Understanding the Masking-Shadowing Function in Microfacet-Based BRDFs

Anisotropic Beckmann Distribution

1 D(ωm, αx , αy ) = π αx αy cos4 θm exp

− tan2 θm

cos2 φm α2x

+

sin2 φm α2y

Anisotropic GGX Distribution

1

D(ωm, αx , αy ) = (π αx αy cos4 θm)

1 + tan2 θm

cos2 φm α2x

+

sin2 φm α2y

2

By using this intuition, we can derive anisotropic forms of the Beckmann and GGX distributions.

66

Validation equations
Classic: positivity, reciprocity, energy conservation

Ω

G1(ωo , ωh) D(ωh) 4 cos θo

d

ωi

=

1

Dωo (ωm) d ωm = 1
Ω
G1(ωo , ωm)〈ωo , ωm〉 D(ωm) d ωm = cos θo
Ω
(ωm · ωg ) D(ωm) d ωm = 1
Ω

2014-09-01

Understanding the Masking-Shadowing Function in Microfacet-Based BRDFs

Classic: positivity, reciprocity, energy conservation

Ω

G1(ωo , ωh) D(ωh) 4 cos θo

d

ωi

=

1

Dωo (ωm) d ωm = 1 Ω G1(ωo , ωm)〈ωo , ωm〉 D(ωm) d ωm = cos θo Ω
(ωm · ωg ) D(ωm) d ωm = 1 Ω

This way of incorporating anisotropy leaves the distributions of normals correctly normalized. What about the next equations related to the masking function?

67

Anisotropy and Stretch Invariance The masking function on anisotropic microsurfaces

2014-09-01

Understanding the Masking-Shadowing Function in Microfacet-Based BRDFs

The masking function on anisotropic microsurfaces

The masking (occlusion) probability is preserved by the stretching operation
In this animated ﬁgure, we can see that after stretching the conﬁguration (the microsurface and the view direction), occluded rays are still occluded and unoccluded ray are still unoccluded. This illustrates an important property: this stretching operation, related to anisotropy, preserves the masking function.
This slide is animated (works with Acrobat Reader).

The masking (occlusion) probability is preserved by the stretching operation 68

Anisotropy and Stretch Invariance The distribution of visible normals on anisotropic microsurfaces

2014-09-01

Understanding the Masking-Shadowing Function in Microfacet-Based BRDFs

The distribution of visible normals on anisotropic microsurfaces

The distribution of visible normals is preserved by the stretching operation
We can see also that the stretching operation preserves the distribution of visible normals.

The distribution of visible normals is preserved by the stretching operation

69

Anisotropy and Stretch Invariance The masking function on anisotropic microsurfaces

2014-09-01

Understanding the Masking-Shadowing Function in Microfacet-Based BRDFs

The masking function on anisotropic microsurfaces

An anisotropic microsurface. What is the masking function?
A practical consequence is that if the masking function is known for an isotropic surface, then it is also known for the associated stretched, anisotropic microsurfaces. For instance, this conﬁguration shows a view direction and an anisotropic microsurface...

An anisotropic microsurface. What is the masking function?
70

Anisotropy and Stretch Invariance The masking function on anisotropic microsurfaces

2014-09-01

Understanding the Masking-Shadowing Function in Microfacet-Based BRDFs

The masking function on anisotropic microsurfaces

The masking function of an isotropic microsurface parametrized by the roughness α2o = cos φ2o α2x + sin φ2o α2y
...and the masking function for this view direction is the masking function of an isotropic microsurface parametrized by the projected roughness αo .

The masking function of an isotropic microsurface parametrized by the roughness

α2o = cos φ2o α2x + sin φ2o α2y

71

Validation equations
Classic: positivity, reciprocity, energy conservation

Ω

G1(ωo , ωh) D(ωh) 4 cos θo

d

ωi

=

1

Dωo (ωm) d ωm = 1
Ω
G1(ωo , ωm)〈ωo , ωm〉 D(ωm) d ωm = cos θo
Ω
(ωm · ωg ) D(ωm) d ωm = 1
Ω

2014-09-01

Understanding the Masking-Shadowing Function in Microfacet-Based BRDFs

Classic: positivity, reciprocity, energy conservation

Ω

G1(ωo , ωh) D(ωh) 4 cos θo

d

ωi

=

1

Dωo (ωm) d ωm = 1 Ω G1(ωo , ωm)〈ωo , ωm〉 D(ωm) d ωm = cos θo Ω
(ωm · ωg ) D(ωm) d ωm = 1 Ω

The masking function derived in this way satisﬁes the validation equations. It is thus the physically meaningful and correct way to represent anisotropy.

72

Conclusion

2014-09-01

Understanding the Masking-Shadowing Function in Microfacet-Based BRDFs

Conclusion

73

Conclusion Validation!

2014-09-01

Understanding the Masking-Shadowing Function in Microfacet-Based BRDFs

Validation!

The purpose of this talk was to provide insights and tools to better understand microfacet models. We have seen that validating microfacet models is important and we have derived strict validation equations to do that. However, it does not mean that the models we call “non-physically based” in this talk shouldn’t be used in practice. The goal was simply to emphasize the properties and limitations of the diﬀerent models on an objective basis, but it is up to you to decide what you want to use in practice.

74

Conclusion −→ This model is the simplest case!
• No multiple scattering • Only one microsurface layer • Only optical geometry Still a lot to explore!

2014-09-01

Understanding the Masking-Shadowing Function in Microfacet-Based BRDFs

−→ This model is the simplest case! • No multiple scattering • Only one microsurface layer • Only optical geometry Still a lot to explore!

As a last remark, I would like to point out that the Cook and Torrance model discussed in this talk, which is also the most widely used one in practice, is actually the simplest case one can think of. It models only single scattering on a one-layer microsurface in the frame of geometric optics. No multiple scattering, no layered materials, no diﬀraction. Obviously there is still a lot to explore in the realm of shading models, which is also why thorough validation is so important. After all, how can we expect to push the microfacet model further if we can’t even get the simplest case right?

75

