© 2021 SIGGRAPH. ALL RIGHTS RESERVED.

Radiance Caching for realtime Global Illumination
Daniel Wright - Epic Games
@EpicShaders
THE PREMIER CONFERENCE & EXHIBITION IN COMPUTER GRAPHICS & INTERACTIVE TECHNIQUES

Final Gather techniques used in Lumen
Advances in Real-Time Rendering SIGGRAPH 2021

Lumen: Dynamic Global Illumination
in Unreal Engine 5
Advances in Real-Time Rendering SIGGRAPH 2021

Targeting games on nextgeneration consoles
Advances in Real-Time Rendering SIGGRAPH 2021

Scaling up to quality-first Enterprise on high end PC
Advances in Real-Time Rendering SIGGRAPH 2021

Background
Advances in Real-Time Rendering SIGGRAPH 2021

Global Illumination
What we are solving for every pixel
Advances in Real-Time Rendering SIGGRAPH 2021

Global Illumination
Final pixel lighting is the Integral over incoming radiance times the BRDF
Advances in Real-Time Rendering SIGGRAPH 2021

Monte Carlo Integration
● Estimate with discrete samples ● Find incoming radiance in a direction with Ray Tracing
Advances in Real-Time Rendering SIGGRAPH 2021

Ray Traces are slow

N1
● Two level BVH

N1

○ Incoherent tree traversal

○ Instance overlap

Advances in Real-Time Rendering SIGGRAPH 2021

Ray Traces are slow
● Can only afford 1/2 ray per pixel ● But quality GI needs hundreds!
Advances in Real-Time Rendering SIGGRAPH 2021

Outdoors:
100 rays per pixel
Advances in Real-Time Rendering SIGGRAPH 2021

Outdoors:
100 rays per pixel

Indoors:
500+ rays per pixel

Advances in Real-Time Rendering SIGGRAPH 2021

Outdoors:
100 rays per pixel
Hard

Indoors:
500+ rays per pixel
Extremely hard

Advances in Real-Time Rendering SIGGRAPH 2021

How can this be made realtime?
Advances in Real-Time Rendering SIGGRAPH 2021

Previous real-time work: Irradiance Fields
● Ray Trace from a small set of probes
○ Arranged in world space grids [Tatarchuk 2012]
● Pre-calculate Irradiance ● Interpolate to full resolution pixels ● Probe Occlusion to reduce leaking [Valient 2014] [McGuire 2019]
Advances in Real-Time Rendering SIGGRAPH 2021

Irradiance Field problems
● Leaking and over-occlusion ● Probe placement ● Slow lighting update ● Distinctive flat look
○ Irradiance near occluders is higher frequency than spatial probe resolution
Advances in Real-Time Rendering SIGGRAPH 2021

Previous real-time work: Screen Space Denoiser
● Ray Trace from pixels
○ Cos distribution ○ ~1 ray per pixel
● Denoise with spatial and temporal reuse
○ Spatiotemporal Variance-Guided Filtering [Schied et al 2017] ○ Fast Denoising with Self Stabilizing Recurrent Blurs [Zhdan 2020]
Advances in Real-Time Rendering SIGGRAPH 2021

Screen Space Denoiser problems
● Input is too noisy - fixed sample rate
Advances in Real-Time Rendering SIGGRAPH 2021

Noise increases as bright feature becomes smaller

Near bright window

Far from window

Advances in Real-Time Rendering SIGGRAPH 2021

Our approach
Advances in Real-Time Rendering SIGGRAPH 2021

Screen Space Radiance Caching
Advances in Real-Time Rendering SIGGRAPH 2021

Downsample incoming radiance
● Incoming light is coherent, geometry normals are not
Advances in Real-Time Rendering SIGGRAPH 2021

Integrate incoming lighting over the BRDF at full res
Advances in Real-Time Rendering SIGGRAPH 2021

Filter in radiance cache space, not screen space
Advances in Real-Time Rendering SIGGRAPH 2021

Better sampling in the first place - importance sample incoming lighting
Advances in Real-Time Rendering SIGGRAPH 2021

Stable distant lighting with World Space Radiance Caching
Advances in Real-Time Rendering SIGGRAPH 2021

Screen Space Denoiser 2 rays per pixel

Raw input compare

Ours 1/2 ray per pixel

Advances in Real-Time Rendering SIGGRAPH 2021

Final Gather Pipeline
Advances in Real-Time Rendering SIGGRAPH 2021

Screen Space Radiance Cache

World Radiance Cache

Screen Bent Normal
Interpolate and Integrate Temporal filter
Advances in Real-Time Rendering SIGGRAPH 2021

Screen Space Radiance Cache
1/16th resolution

World Radiance Cache
~1/64th resolution

Screen Bent Normal

Full resolution

Interpolate and Integrate
Temporal filter
Advances in Real-Time Rendering SIGGRAPH 2021

Screen Bent Normal

Place Probes on GBuffer
Generate rays
Trace Probe space filtering

World Radiance Cache

Interpolate and Integrate
Temporal filter
Advances in Real-Time Rendering SIGGRAPH 2021

Screen Probe structure
● Octahedral atlas with border
○ Typically 8x8 per probe ○ Uniformly distributed world space directions ○ Neighbors have matching directions
● Radiance and HitDistance in 2d atlas
Advances in Real-Time Rendering SIGGRAPH 2021

Screen Probe placement
● Adaptive placement with Hierarchical Refinement [Křivánek et al 2007]
○ Iteratively place where interpolation fails

16

8

4

Advances in Real-Time Rendering SIGGRAPH 2021

Screen Probe placement
● Adaptive placement with Hierarchical Refinement [Křivánek et al 2007]
○ Iteratively place where interpolation fails
● Flood fill for final level

16

8

4

Flood fill

Advances in Real-Time Rendering SIGGRAPH 2021

Adaptive sampling
● Need upper limit for real-time ● Don’t want extra barriers for processing adaptive probes
○ Place adaptive probes at the bottom of the atlas

16

8

4

Advances in Real-Time Rendering SIGGRAPH 2021

Screen Probe jittering
● Temporally jitter placement grid and direction ● Place directly on pixels
○ No leaking ○ Occlusion differences within screen cell have to be hidden with temporal filter

Frame 1

Frame 2

Advances in Real-Time Rendering SIGGRAPH 2021

Interpolation
● Plane distance weighting
○ Prevents foreground misses leaking onto background
Advances in Real-Time Rendering SIGGRAPH 2021

Interpolation
● Plane distance weighting
○ Prevents foreground misses leaking onto background
● Jitter offset into interpolation
○ *only if still in same plane ○ Distributes differences between probes
spatially ○ Temporally stabilizes final lighting by
expanding TAA 3x3 neighborhood
Advances in Real-Time Rendering SIGGRAPH 2021

Screen Space Radiance Cache pipeline validation
● Matches path tracer when cranked up
Advances in Real-Time Rendering SIGGRAPH 2021

But too much noise at ½ ray per pixel
Advances in Real-Time Rendering SIGGRAPH 2021

Importance Sampling
Advances in Real-Time Rendering SIGGRAPH 2021

● We would like to distribute rays proportional to the integrand ● How can we estimate these?
Advances in Real-Time Rendering SIGGRAPH 2021

● Incoming Radiance:
○ Reproject last frame’s Screen Probe Radiance! ■ No need to do an expensive search ■ Rays already indexed by position and direction
○ Fallback to World Space Probe Radiance on disocclusion
Advances in Real-Time Rendering SIGGRAPH 2021

● BRDF:
○ Accumulate from pixels that will use this Screen Probe
Advances in Real-Time Rendering SIGGRAPH 2021

● Even better, we would like to sample proportional to the product of the incoming Radiance and BRDF
Advances in Real-Time Rendering SIGGRAPH 2021

Structured Importance Sampling
● Assigns a small number of samples to hierarchically structured areas of the Probability Density Function (PDF) [Agarwal et al 2003]
○ Achieves good global stratification ○ Sample placement requires offline algorithm
Advances in Real-Time Rendering SIGGRAPH 2021

Maps perfectly to Octahedral mip quadtree!
Advances in Real-Time Rendering SIGGRAPH 2021

Integrating into pipeline
● Add indirection to tracing lanes
○ Store RayCoord, MipLevel
● After tracing, composite TraceRadiance into uniform probe layout for final integration
Composite
Advances in Real-Time Rendering SIGGRAPH 2021

Ray Generation algorithm

● Calculate BRDF PDF * Lighting PDF for each Octahedral texel ● Start with uniformly distributed probe ray directions
○ Want fixed output ray count - keep tracing lanes full
● Sort rays by PDF ● For every 3 rays with PDF below cull threshold, supersample matching high PDF ray

BRDF

Lighting

Culled directions

Advances in Real-Time RendSeurinpgeSrsIGaGmRpAPleHd2d02ir1ections

Advances in Real-Time Rendering SIGGRAPH 2021

Improvements
● Don’t allow Lighting PDF to cull rays
○ Lighting PDF is approximate, BRDF is accurate
● Can cull more aggressively by leaning on spatial filter
○ Cull with higher BRDF threshold ○ Reduce weight of culled rays during spatial filter
■ Fixes darkening around corners
Advances in Real-Time Rendering SIGGRAPH 2021

Results
Advances in Real-Time Rendering SIGGRAPH 2021

Results
Advances in Real-Time Rendering SIGGRAPH 2021

Importance Sampling recap
● Guide this frame’s rays with last frame’s lighting, and distant lighting ● Bundling rays into probes lets us afford smarter sampling
Advances in Real-Time Rendering SIGGRAPH 2021

Spatial filtering
Advances in Real-Time Rendering SIGGRAPH 2021

Filtering in Radiance Cache space
● Large spatial filter for cheap
○ 3^2 in probe space vs 48^2 screen space
● Can ignore normal differences between spatial neighbors
○ Only depth weighting
Advances in Real-Time Rendering SIGGRAPH 2021

Gather Radiance from neighbors
● Gather from matching Octahedral cell in neighbor probes ● Error weighting:
○ Angle error from reprojected neighbor ray hits ○ Filters distant lighting, preserves local shadowing
Advances in Real-Time Rendering SIGGRAPH 2021

Reproject neighbor hits
●G
Advances in Real-Time Rendering SIGGRAPH 2021

Reproject neighbor hits
●G
?
Advances in Real-Time Rendering SIGGRAPH 2021

Preserving contact shadows
● Angle error biases toward distant light = leaking
○ Distant light has no parallax and never gets rejected
● Solution: clamp neighbor hit distance to our own before reprojection
Advances in Real-Time Rendering SIGGRAPH 2021

Advances in Real-Time Rendering SIGGRAPH 2021

Advances in Real-Time Rendering SIGGRAPH 2021

Reproject neighbor hits Final filtering compare
●G
Advances in Real-Time Rendering SIGGRAPH 2021

World Space Radiance Cache
Advances in Real-Time Rendering SIGGRAPH 2021

Problem: distant lighting
● Noise from small bright feature increases with distance ● Long incoherent traces are slow ● Distant lighting is changing slowly - opportunity to cache
○ Redundant operations for nearby Screen Probes
Advances in Real-Time Rendering SIGGRAPH 2021

Solution: separate sampling for distant Radiance
● World space Radiance Caching for distant lighting
○ The Technology of The Tomorrow Children [McLaren 2015]
● Stable error since world space - easy to hide
○ Just like Volumetric Lightmaps
Advances in Real-Time Rendering SIGGRAPH 2021

Screen Space Radiance Cache

World Radiance Cache

Screen Bent Normal
Interpolate and Integrate Temporal filter
Advances in Real-Time Rendering SIGGRAPH 2021

Pipeline integration
● Place around Screen Probes ● Then trace to compute Radiance ● Interpolate to solve distant lighting for Screen Probe rays

Screen Radiance Cache
Place Probes on GBuffer
Trace

World Radiance Cache
Place Probes Trace

Advances in Real-Time Rendering SIGGRAPH 2021

Connecting rays

Screen Probe ray

World Probe ray

Advances in Real-Time Rendering SIGGRAPH 2021

Avoiding self-lighting
● World Probe ray must skip the interpolation footprint
Interpolation footprint
World Probe ray
Advances in Real-Time Rendering SIGGRAPH 2021

Connecting rays
● Screen Probe ray must cover interpolation footprint + skipped distance

Screen Probe ray

World Probe ray

Advances in Real-Time Rendering SIGGRAPH 2021

Problem: leaking!
● World probe radiance should have been occluded
○ But wasn’t due to incorrect parallax

Screen Probe ray

World Probe ray

Advances in Real-Time Rendering SIGGRAPH 2021

Solution: simple sphere parallax
● Reproject Screen Probe ray intersection with World Probe sphere
Corrected World Probe ray Screen Probe ray
Advances in Real-Time Rendering SIGGRAPH 2021

Sparse coverage
● 3d clipmap grids centered around camera storing ProbeIndex into atlas
○ Clipmap distribution maintains bounded screen size
Advances in Real-Time Rendering SIGGRAPH 2021

Atlas
● Octahedral probe atlas storing Radiance, TraceDistance
○ Typically 32x32 Radiance per probe
Advances in Real-Time Rendering SIGGRAPH 2021

Placement and caching
● Mark any position that we will interpolate from later in clipmap indirections
● For each marked world probe:
○ Reuse traces from last frame, or allocate new probe index
○ Re-trace a subset of cache hits to propagate lighting changes

Place Probes Reuse existing probe traces
Generate rays Trace
Probe space filtering

Advances in Real-Time Rendering SIGGRAPH 2021

Problem: highly variable costs
● Fast camera movements and disocclusions require many uncached probes to be traced
Advances in Real-Time Rendering SIGGRAPH 2021

Problem: highly variable costs
● Fast camera movements and disocclusions require many uncached probes to be traced
● Solution: Fixed budget for full resolution probes
○ Additional probe traces for cache misses are at lower resolution ○ Additional probe traces for lighting updates are skipped
Advances in Real-Time Rendering SIGGRAPH 2021

Importance Sampling
● BRDF importance sampling
○ Accumulate BRDF from Screen Probes ○ Dice probes into trace tiles ○ Generate trace tile resolution according to BRDF
● Supersample near camera
○ Up to 64x64 effective resolution ■ 4096 traces! ■ Very stable distant lighting

Place Probes Reuse existing probe traces
Generate rays Trace
Probe space filtering

Advances in Real-Time Rendering SIGGRAPH 2021

Spatial filtering between probes
● Reproject neighbor hits again ● Problem: can’t assume mutual visibility
Neighbor
?
Probe

Place Probes Reuse existing probe traces
Generate rays Trace
Probe space filtering

Advances in Real-Time Rendering SIGGRAPH 2021

Preventing leaking
● Ideally re-trace neighbor ray path through probe depths
● Single occlusion test works well
○ Nearly free - reuses probe depths

Neighbor Probe

Wall

Place Probes Reuse existing probe traces
Generate rays Trace
Probe space filtering

Advances in Real-Time Rendering SIGGRAPH 2021

Results
Advances in Real-Time Rendering SIGGRAPH 2021

Temporal stability improved
Advances in Real-Time Rendering SIGGRAPH 2021

Also used by
● Guiding Screen Probe importance sampling ● Hair ● Translucency ● Multi-bounce
Advances in Real-Time Rendering SIGGRAPH 2021

Full resolution steps
Advances in Real-Time Rendering SIGGRAPH 2021

Screen Space Radiance Cache

World Radiance Cache

Screen Bent Normal
Interpolate and Integrate Temporal filter
Advances in Real-Time Rendering SIGGRAPH 2021

Final integration
Advances in Real-Time Rendering SIGGRAPH 2021

Monte Carlo integration noise
● Importance sampling BRDF causes incoherent fetches
○ 8spp * 4 neighbor probe direction lookups
● Can use mips (Filtered Importance Sampling), but that causes self-lighting [Colbert et al 2007]
○ Especially around areas of direct lighting
Advances in Real-Time Rendering SIGGRAPH 2021

Convert Probe Radiance to 3rd order Spherical Harmonic
● SH is calculated per Screen Probe ● Full res pixels load SH coherently ● SH Diffuse integration cheap and high quality [Ramamoorthi 2001]
Advances in Real-Time Rendering SIGGRAPH 2021

Rough specular
● Ray Traced Reflections expensive at high roughness
○ Converges on diffuse
Advances in Real-Time Rendering SIGGRAPH 2021

Rough specular - reuse Screen Probes
● Generate directions from GGX, sample probe radiance
● Automatically leverage probe sampling and filtering already done!
Advances in Real-Time Rendering SIGGRAPH 2021

Downsampled tracing loses contact shadows
Advances in Real-Time Rendering SIGGRAPH 2021

Full resolution Bent Normal
● Computed with fast screen traces
○ Trace distance coupled to the distance between Screen Probes: ~16 pixels
Advances in Real-Time Rendering SIGGRAPH 2021

Integrating with Screen Space Radiance Cache
● Treat Screen Probe GI as Far-Field Irradiance ● Full resolution Bent Normal represents amount of Near-Field
○ Horizon-Based Indirect Lighting [Mayaux 2018] ○ Multi-bounce approximation gives Near-Field Irradiance

Advances in Real-Time Rendering SIGGRAPH 2021

Image credit: Benoit Mayaux

Results
Advances in Real-Time Rendering SIGGRAPH 2021

Results
Advances in Real-Time Rendering SIGGRAPH 2021

Temporal filter
● Jittering probe position requires reliable temporal filter ● Using depth rejection
○ Stable results, but also slow reaction to lighting changes
Advances in Real-Time Rendering SIGGRAPH 2021

Track hit velocity along with hit depth during tracing
Projected area belonging to fast moving objects
Advances in Real-Time Rendering SIGGRAPH 2021

Switch to fast update mode when traces hit fast moving object
● Lower temporal filter, raise spatial filter
Advances in Real-Time Rendering SIGGRAPH 2021

